# üìÅ accounts/signals.py - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø –ë–ï–ó —Ü–∏–∫–ª–∏—á–µ—Å–∫–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞

from django.db.models.signals import post_save
from django.dispatch import receiver
from django.contrib.auth.models import User


# üóëÔ∏è –£–ë–†–ê–ù –ü–†–Ø–ú–û–ô –ò–ú–ü–û–†–¢: from accounts.models import Profile
# ‚úÖ –ò–°–ü–û–õ–¨–ó–£–ï–ú –ü–û–ó–î–ù–ò–ô –ò–ú–ü–û–†–¢ –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–π


@receiver(post_save, sender=User)
def create_user_profile(sender, instance, created, **kwargs):
    """üë§ –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    if created:
        # üîÑ –ü–û–ó–î–ù–ò–ô –ò–ú–ü–û–†–¢ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è —Ü–∏–∫–ª–∏—á–µ—Å–∫–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞
        from accounts.models import Profile
        Profile.objects.create(user=instance)


@receiver(post_save, sender=User)
def save_user_profile(sender, instance, **kwargs):
    """üíæ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è"""
    try:
        # üîÑ –ü–û–ó–î–ù–ò–ô –ò–ú–ü–û–†–¢ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è —Ü–∏–∫–ª–∏—á–µ—Å–∫–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞
        from accounts.models import Profile

        # üõ°Ô∏è –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
        if hasattr(instance, 'profile'):
            instance.profile.save()
        else:
            # üÜï –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
            Profile.objects.get_or_create(user=instance)
    except Exception as e:
        # üìù –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É, –Ω–æ –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å
        print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è –¥–ª—è {instance.username}: {e}")

# üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø:
# ‚úÖ –£–ë–†–ê–ù –ø—Ä—è–º–æ–π –∏–º–ø–æ—Ä—Ç Profile (–ø—Ä–∏—á–∏–Ω–∞ —Ü–∏–∫–ª–∏—á–µ—Å–∫–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞)
# ‚úÖ –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø –ø–æ–∑–¥–Ω–∏–π –∏–º–ø–æ—Ä—Ç –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–π
# ‚úÖ –î–û–ë–ê–í–õ–ï–ù–ê –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
# ‚úÖ –°–û–•–†–ê–ù–ï–ù–ê –≤—Å—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —Å–∏–≥–Ω–∞–ª–æ–≤

# üí° –ü–†–ò–ú–ï–ß–ê–ù–ò–ï:
# –ü–æ–∑–¥–Ω–∏–π –∏–º–ø–æ—Ä—Ç –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏–∑–±–µ–∂–∞—Ç—å —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
# –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ Django –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π