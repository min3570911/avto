# check_db_structure.py - –£–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π

import os
import sys

# --- –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: –®–∞–≥ 1 ---
print("‚úÖ –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω...")

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è Django ---
try:
    # –£–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'ecomm.settings')
    # --- –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: –®–∞–≥ 2 ---
    print(f"‚öôÔ∏è  –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ñ–∞–π–ª –Ω–∞—Å—Ç—Ä–æ–µ–∫: {os.environ['DJANGO_SETTINGS_MODULE']}")

    import django

    # --- –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: –®–∞–≥ 3 ---
    print(f"üêç –í–µ—Ä—Å–∏—è Django: {django.get_version()}. –ó–∞–≥—Ä—É–∂–∞—é –º–æ–¥–µ–ª–∏...")

    django.setup()
    # --- –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: –®–∞–≥ 4 ---
    print("üöÄ –ú–æ–¥–µ–ª–∏ Django —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!")

    # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–æ–¥–µ–ª–∏ —Ç–æ–ª—å–∫–æ –ü–û–°–õ–ï django.setup()
    from django.apps import apps

except Exception as e:
    print("\n" + "=" * 80)
    print(f"‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –æ–∫—Ä—É–∂–µ–Ω–∏–µ Django.")
    print(f"   –î–µ—Ç–∞–ª–∏: {e}")
    print("   –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:")
    print("   1. –í—ã –∑–∞–ø—É—Å–∫–∞–µ—Ç–µ —Å–∫—Ä–∏–ø—Ç –Ω–µ –∏–∑ –∫–æ—Ä–Ω–µ–≤–æ–π –ø–∞–ø–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ (D:\\YandexDisk\\avtokovriki).")
    print("   2. –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ.")
    print("   3. –ò–º—è –ø—Ä–æ–µ–∫—Ç–∞ –≤ 'ecomm.settings' —É–∫–∞–∑–∞–Ω–æ –Ω–µ–≤–µ—Ä–Ω–æ.")
    print("=" * 80)
    sys.exit(1)  # –í—ã—Ö–æ–¥ —Å –∫–æ–¥–æ–º –æ—à–∏–±–∫–∏


# --- –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è ---
def run_db_scan():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏ –≤—ã–≤–æ–¥–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ë–î."""
    print("\n" + "=" * 80)
    print("üïµÔ∏è  –ù–ê–ß–ò–ù–ê–Æ –ü–û–õ–ù–û–ï –°–ö–ê–ù–ò–†–û–í–ê–ù–ò–ï –ë–ê–ó–´ –î–ê–ù–ù–´–•...")
    print("=" * 80)

    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –º–æ–¥–µ–ª–∏, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤ –ø—Ä–æ–µ–∫—Ç–µ
    all_models = apps.get_models()

    if not all_models:
        print("‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–π –º–æ–¥–µ–ª–∏ –≤ –ø—Ä–æ–µ–∫—Ç–µ.")
        return

    # –§–∏–ª—å—Ç—Ä—É–µ–º —Å–ª—É–∂–µ–±–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, —á—Ç–æ–±—ã –Ω–µ –∑–∞–≥—Ä–æ–º–æ–∂–¥–∞—Ç—å –≤—ã–≤–æ–¥
    excluded_apps = ['admin', 'auth', 'contenttypes', 'sessions']
    models_to_scan = [m for m in all_models if m._meta.app_label not in excluded_apps]

    if not models_to_scan:
        print("‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω–æ –º–æ–¥–µ–ª–µ–π –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (—Ç–æ–ª—å–∫–æ —Å–ª—É–∂–µ–±–Ω—ã–µ Django).")
        return

    for model in models_to_scan:
        app_label = model._meta.app_label
        model_name = model.__name__
        table_name = model._meta.db_table

        print("\n" + "-" * 80)
        print(f"üì± –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: {app_label.upper()} | üì¶ –ú–æ–¥–µ–ª—å: {model_name} | üóÇÔ∏è –¢–∞–±–ª–∏—Ü–∞: {table_name}")
        print("-" * 80)

        try:
            count = model.objects.count()
            print(f"  üìà –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π: {count}")

            print(f"  üî© –ü–æ–ª—è –º–æ–¥–µ–ª–∏:")
            for field in model._meta.get_fields():
                if not (field.auto_created and not field.concrete):  # –£–±–∏—Ä–∞–µ–º "–º—É—Å–æ—Ä–Ω—ã–µ" –ø–æ–ª—è
                    print(f"    - {field.name}: {field.get_internal_type()}")

            if count > 0:
                print(f"  üìù –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø–∏—Å–µ–π (–ø–µ—Ä–≤—ã–µ 3):")
                examples = model.objects.all()[:3]
                for i, item in enumerate(examples):
                    print(f"    {i + 1}. {str(item)}")
            else:
                print(f"  üìù –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø–∏—Å–µ–π: (—Ç–∞–±–ª–∏—Ü–∞ –ø—É—Å—Ç–∞)")

        except Exception as e:
            print(f"  ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –º–æ–¥–µ–ª–∏ {model_name}: {e}")

    print("\n" + "=" * 80)
    print("‚úÖ –°–ö–ê–ù–ò–†–û–í–ê–ù–ò–ï –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù–û.")
    print("=" * 80)


# --- –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –≤ —Å–∫—Ä–∏–ø—Ç ---
# –≠—Ç–æ—Ç –±–ª–æ–∫ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ —Ñ–∞–π–ª –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é
if __name__ == "__main__":
    # --- –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: –®–∞–≥ 5 ---
    print("–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ (__main__) –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞. –ó–∞–ø—É—Å–∫–∞—é —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ...")
    run_db_scan()