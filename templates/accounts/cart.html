{% extends "base/base.html"%}
{% block title %}–ö–æ—Ä–∑–∏–Ω–∞{% endblock %}
{% block start %} {% load static %}

<style>
  /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ */
  @media (max-width: 576px) {
    .table-shopping-cart thead {
      display: none;
    }

    .table-shopping-cart,
    .table-shopping-cart tbody,
    .table-shopping-cart tr,
    .table-shopping-cart td {
      display: block;
      width: 100%;
    }

    .table-shopping-cart tr {
      margin-bottom: 15px;
      border-bottom: 1px solid #eee;
      padding-bottom: 15px;
    }

    .itemside {
      display: flex;
      align-items: center;
    }

    .price-wrap {
      margin: 10px 0;
    }

    .action-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
    }
  }

  /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è/–ø–æ–∫–∞–∑–∞ –±–ª–æ–∫–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ */
  .delivery-section {
    display: none;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #eee;
  }

  .delivery-section.active {
    display: block;
  }

  /* –£–ª—É—á—à–µ–Ω–∏—è –¥–ª—è —á–µ–∫–±–æ–∫—Å–∞ */
  .custom-checkbox-container {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
  }

  .custom-checkbox-container input[type="checkbox"] {
    margin-right: 10px;
  }

  /* –°—Ç–∏–ª–∏ –¥–ª—è —Å—É–º–º—ã –∏—Ç–æ–≥–æ */
  .total-amount-container {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    margin: 20px 0;
  }

  .total-amount-label {
    font-size: 22px;
    font-weight: bold;
    margin-right: 15px;
  }

  .total-amount-value {
    font-size: 24px;
    font-weight: bold;
    color: #dc3545;
  }
</style>

<section class="section-content padding-y">
    <div class="container">
        {% include 'base/alert.html' %}

        <!-- –ë–ª–æ–∫ —Å —Ç–æ–≤–∞—Ä–∞–º–∏ –≤ –∫–æ—Ä–∑–∏–Ω–µ -->
        <div class="card mb-3">
            <table class="table table-borderless table-shopping-cart">
                <thead class="text-muted">
                    <tr class="small text-uppercase">
                        <th scope="col">–¢–æ–≤–∞—Ä</th>
                        <th scope="col" width="120">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                        <th scope="col" width="120">–¶–µ–Ω–∞</th>
                        <th scope="col" class="text-right" width="100"></th>
                    </tr>
                </thead>
                <tbody>
                    {% for cart_item in cart.cart_items.all %}
                    <tr>
                        <td>
                            <figure class="itemside">
                                <div class="aside">
                                    {% if cart_item.kit_variant and cart_item.kit_variant.image %}
                                    <img src="{{ cart_item.kit_variant.image.url }}" class="img-sm"
                                        alt="{{ cart_item.kit_variant.name }}" />
                                    {% else %}
                                    <img src="/media/{{ cart_item.product.product_images.first.image }}"
                                        class="img-sm" alt="{{ cart_item.product.product_name }}" />
                                    {% endif %}
                                </div>
                                <figcaption class="info">
                                    <a href="{% url 'get_product' cart_item.product.slug %}"
                                        class="title text-dark">
                                        {{ cart_item.product.product_name }}
                                    </a>

                                    <p class="text-muted small mb-0">
                                        {% if cart_item.kit_variant %}
                                        –ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è: {{ cart_item.kit_variant.name }}<br />
                                        {% endif %}

                                        {% if cart_item.carpet_color %}
                                        –¶–≤–µ—Ç –∫–æ–≤—Ä–∏–∫–∞:
                                        <span
                                            style="display: inline-block; width: 12px; height: 12px; background-color: {{ cart_item.carpet_color.hex_code }}; border: 1px solid #ccc;"></span>
                                        {{ cart_item.carpet_color.name }}<br />
                                        {% endif %}

                                        {% if cart_item.border_color %}
                                        –¶–≤–µ—Ç –æ–∫–∞–Ω—Ç–æ–≤–∫–∏:
                                        <span
                                            style="display: inline-block; width: 12px; height: 12px; background-color: {{ cart_item.border_color.hex_code }}; border: 1px solid #ccc;"></span>
                                        {{ cart_item.border_color.name }}<br />
                                        {% endif %}

                                        {% if cart_item.has_podpyatnik %}
                                        –° –ø–æ–¥–ø—è—Ç–Ω–∏–∫–æ–º<br />
                                        {% endif %}
                                    </p>
                                </figcaption>
                            </figure>
                        </td>
                        <td>
                            <select class="form-control"
                                onchange="updateCartItem(this, '{{ cart_item.uid }}')">
                                {% for i in quantity_range %}
                                <option value="{{ i }}" {% if cart_item.quantity == i %}selected{% endif %}>
                                    {{ i }}
                                </option>
                                {% endfor %}
                            </select>
                        </td>
                        <td>
                            <div class="price-wrap">
                                <var class="price">‚Çπ{{ cart_item.get_product_price }}</var>
                            </div>
                        </td>
                        <td class="text-right">
                            <a href="{% url 'remove_cart' cart_item.uid %}" class="btn btn-danger">
                                –£–¥–∞–ª–∏—Ç—å
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <!-- –ë–ª–æ–∫ —Å –∫–Ω–æ–ø–∫–æ–π –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∫—É–ø–∫–∏ -->
            <div class="card-body border-top">
                <a href="{% url 'index' %}" class="btn btn-light">
                    <i class="fa fa-chevron-left"></i> –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∫—É–ø–∫–∏
                </a>
            </div>
        </div>

        <!-- –ë–ª–æ–∫ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –¥–æ—Å—Ç–∞–≤–∫–µ -->
        <div class="card mb-3">
            <div class="card-body">
                <i class="fa fa-truck text-success mr-2"></i> –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ –ø—Ä–µ–¥–æ–ø–ª–∞—Ç–µ –∏–ª–∏ –Ω–∞–ª–æ–∂–µ–Ω–Ω—ã–º –ø–ª–∞—Ç–µ–∂–æ–º. –°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤–µ—Å–∞ –∏ –¥–∞–ª—å–Ω–æ—Å—Ç–∏ —Ä–µ–≥–∏–æ–Ω–∞ –†–ë. –°—Ä–æ–∫–∏ –¥–æ—Å—Ç–∞–≤–∫–∏: 2-3 –¥–Ω—è.
            </div>
        </div>

        <!-- –§–û–†–ú–ê –û–§–û–†–ú–õ–ï–ù–ò–Ø –ó–ê–ö–ê–ó–ê -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{% url 'place_order' %}" id="orderForm">
                    {% csrf_token %}

                    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                    <div class="form-group">
                        <label for="customer_name">–ò–º—è</label>
                        <input type="text" class="form-control" id="customer_name" name="customer_name" required>
                    </div>

                    <div class="form-group">
                        <label for="customer_phone">–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω</label>
                        <input type="tel" class="form-control" id="customer_phone" name="customer_phone" required>
                    </div>

                    <div class="form-group">
                        <label for="customer_city">–ì–æ—Ä–æ–¥</label>
                        <input type="text" class="form-control" id="customer_city" name="customer_city" required>
                    </div>

                    <!-- –ß–µ–∫–±–æ–∫—Å –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏ -->
                    <div class="custom-checkbox-container">
                        <input type="checkbox" id="need_delivery" name="need_delivery"
                               onclick="toggleDeliverySection()">
                        <label for="need_delivery">
                            üöö –ù—É–∂–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∞ (–æ–ø–ª–∞—á–∏–≤–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ)
                        </label>
                    </div>

                    <!-- –°–∫—Ä—ã–≤–∞–µ–º–∞—è —Å–µ–∫—Ü–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏ -->
                    <div id="deliverySection" class="delivery-section">
                        <!-- –°–ø–æ—Å–æ–± –¥–æ—Å—Ç–∞–≤–∫–∏ -->
                        <div class="form-group">
                            <label>–°–ø–æ—Å–æ–± –¥–æ—Å—Ç–∞–≤–∫–∏</label>
                            <div class="custom-control custom-radio mb-2">
                                <input type="radio" id="delivery_europochta" name="delivery_method" value="europochta" class="custom-control-input" checked>
                                <label class="custom-control-label" for="delivery_europochta">–ï–≤—Ä–æ–ø–æ—á—Ç–∞ –ø–æ –ë–µ–ª–∞—Ä—É—Å–∏</label>
                            </div>
                            <div class="custom-control custom-radio mb-2">
                                <input type="radio" id="delivery_belpochta" name="delivery_method" value="belpochta" class="custom-control-input">
                                <label class="custom-control-label" for="delivery_belpochta">–ë–µ–ª–ø–æ—á—Ç–∞ –ø–æ –ë–µ–ª–∞—Ä—É—Å–∏</label>
                            </div>
                            <div class="custom-control custom-radio">
                                <input type="radio" id="delivery_yandex" name="delivery_method" value="yandex" class="custom-control-input">
                                <label class="custom-control-label" for="delivery_yandex">–Ø–Ω–¥–µ–∫—Å –∫—É—Ä—å–µ—Ä –ø–æ –ú–∏–Ω—Å–∫—É</label>
                            </div>
                        </div>

                        <!-- –ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ -->
                        <div class="form-group">
                            <label for="shipping_address">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</label>
                            <textarea class="form-control" id="shipping_address" name="shipping_address" rows="3"
                                placeholder="–î–ª—è –ï–≤—Ä–æ–ø–æ—á—Ç—ã/–ë–µ–ª–ø–æ—á—Ç—ã: –æ—Ç–¥–µ–ª–µ–Ω–∏–µ –∏ –≥–æ—Ä–æ–¥. –î–ª—è –∫—É—Ä—å–µ—Ä–∞: –ø–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å –≤ –ú–∏–Ω—Å–∫–µ"></textarea>
                        </div>
                    </div>

                    <!-- –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ –∫ –∑–∞–∫–∞–∑—É -->
                    <div class="form-group">
                        <label for="order_notes">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ –∫ –∑–∞–∫–∞–∑—É</label>
                        <textarea class="form-control" id="order_notes" name="order_notes" rows="2"></textarea>
                    </div>

                    <!-- –°–æ–≥–ª–∞—Å–∏–µ —Å —É—Å–ª–æ–≤–∏—è–º–∏ -->
                    <div class="custom-checkbox-container">
                        <input type="checkbox" id="terms_agree" name="terms_agree" required>
                        <label for="terms_agree">
                            –û—Ñ–æ—Ä–º–ª—è—è –∑–∞–∫–∞–∑, —è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é —Å–≤–æ–µ —Å–æ–≥–ª–∞—Å–∏–µ —Å
                            <a href="/terms/" target="_blank">–£—Å–ª–æ–≤–∏—è–º–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–∞–π—Ç–∞</a> –∏
                            <a href="/return-policy/" target="_blank">–£—Å–ª–æ–≤–∏—è–º–∏ –≤–æ–∑–≤—Ä–∞—Ç–∞ —Ç–æ–≤–∞—Ä–∞</a>
                        </label>
                    </div>

                    <!-- –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å (—É–≤–µ–ª–∏—á–µ–Ω–Ω–∞—è –∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–Ω–∞—è) -->
                    <div class="total-amount-container">
                        <span class="total-amount-label">–ò–¢–û–ì–û:</span>
                        <span class="total-amount-value">‚Çπ{{ cart.get_cart_total }}</span>
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ -->
                    <button type="submit" class="btn btn-primary btn-block" id="placeOrderBtn">
                        –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑
                    </button>
                </form>
            </div>
        </div>
    </div>
</section>

<script>
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Å–µ–∫—Ü–∏–∏ –¥–æ—Å—Ç–∞–≤–∫–∏
    function toggleDeliverySection() {
        const deliverySection = document.getElementById('deliverySection');
        const needDelivery = document.getElementById('need_delivery').checked;

        if (needDelivery) {
            deliverySection.classList.add('active');
            document.getElementById('shipping_address').setAttribute('required', 'required');
        } else {
            deliverySection.classList.remove('active');
            document.getElementById('shipping_address').removeAttribute('required');
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–∞
    function updateCartItem(selectElement, cartItemId) {
        const quantity = selectElement.value;

        fetch("{% url 'update_cart_item' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({
                "cart_item_id": cartItemId,
                "quantity": quantity
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.reload();
            } else {
                alert("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ—Ä–∑–∏–Ω—ã");
            }
        });
    }

    // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
    document.getElementById('orderForm').addEventListener('submit', function(e) {
        // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ–ª–µ–π
        const name = document.getElementById('customer_name').value.trim();
        const phone = document.getElementById('customer_phone').value.trim();
        const city = document.getElementById('customer_city').value.trim();
        const termsAgree = document.getElementById('terms_agree').checked;
        const needDelivery = document.getElementById('need_delivery').checked;

        let hasErrors = false;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
        if (!name) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –≤–∞—à–µ –∏–º—è');
            e.preventDefault();
            hasErrors = true;
        }

        if (!phone) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω');
            e.preventDefault();
            hasErrors = true;
        }

        if (!city) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –≥–æ—Ä–æ–¥');
            e.preventDefault();
            hasErrors = true;
        }

        if (!termsAgree) {
            alert('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–≥–ª–∞—Å–∏—Ç—å—Å—è —Å —É—Å–ª–æ–≤–∏—è–º–∏');
            e.preventDefault();
            hasErrors = true;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏, –µ—Å–ª–∏ –æ–Ω–∞ –≤—ã–±—Ä–∞–Ω–∞
        if (needDelivery) {
            const address = document.getElementById('shipping_address').value.trim();
            if (!address) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏');
                e.preventDefault();
                hasErrors = true;
            }
        }

        // –ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã
        if (hasErrors) {
            return false;
        }

        // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
        const btn = document.getElementById('placeOrderBtn');
        btn.disabled = true;
        btn.innerHTML = '–û—Ñ–æ—Ä–º–ª—è–µ–º –∑–∞–∫–∞–∑...';
    });
</script>
{% endblock %}