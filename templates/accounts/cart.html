{% extends "base/base.html"%}
{% block title %}–ö–æ—Ä–∑–∏–Ω–∞{% endblock %}
{% block start %} {% load static %}

<style>
  /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ */
  @media (max-width: 576px) {
    .table-shopping-cart thead {
      display: none;
    }

    .table-shopping-cart,
    .table-shopping-cart tbody,
    .table-shopping-cart tr,
    .table-shopping-cart td {
      display: block;
      width: 100%;
    }

    .table-shopping-cart tr {
      margin-bottom: 15px;
      border-bottom: 1px solid #eee;
      padding-bottom: 15px;
    }

    .itemside {
      display: flex;
      align-items: center;
    }

    .price-wrap {
      margin: 10px 0;
    }

    .action-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
    }
  }

  /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è/–ø–æ–∫–∞–∑–∞ –±–ª–æ–∫–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ */
  .delivery-section {
    display: none;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #eee;
    transition: all 0.3s ease;
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
  }

  .delivery-section.active {
    display: block;
  }

  /* –£–ª—É—á—à–µ–Ω–∏—è –¥–ª—è —á–µ–∫–±–æ–∫—Å–∞ */
  .custom-checkbox-container {
    display: flex;
    align-items: flex-start;
    margin-bottom: 15px;
  }

  .custom-checkbox-container input[type="checkbox"] {
    margin-right: 10px;
    margin-top: 2px;
    transform: scale(1.2);
  }

  /* –°—Ç–∏–ª–∏ –¥–ª—è —Å—É–º–º—ã –∏—Ç–æ–≥–æ */
  .total-amount-container {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    margin: 20px 0;
    padding: 20px;
    background: linear-gradient(135deg, #28a745, #20c997);
    border-radius: 10px;
    color: white;
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
  }

  .total-amount-label {
    font-size: 22px;
    font-weight: bold;
    margin-right: 15px;
  }

  .total-amount-value {
    font-size: 28px;
    font-weight: bold;
  }

  /* üö® –°—Ç–∏–ª–∏ –¥–ª—è –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ */
  .error-message {
    color: #dc3545;
    font-size: 14px;
    margin-top: 5px;
    display: none;
  }

  .form-group.error input,
  .form-group.error textarea {
    border-color: #dc3545;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
  }

  .form-group.error .error-message {
    display: block;
  }

  /* üîÑ –£–ü–†–û–©–ï–ù–ù–´–ï —Å—Ç–∏–ª–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ë–ï–ó –≤—Ä–∞—â–µ–Ω–∏—è */
  .btn-loading:disabled {
    opacity: 0.7;
    cursor: not-allowed;
  }

  /* ‚úÖ –£–ë–ò–†–ê–ï–ú –≤–µ—Å—å –≤—Ä–∞—â–∞—é—â–∏–π—Å—è —Å–ø–∏–Ω–Ω–µ—Ä! */
  /* –í–º–µ—Å—Ç–æ –Ω–µ–≥–æ - –ø—Ä–æ—Å—Ç—ã–µ —Ç–æ—á–∫–∏ */
  .loading-dots {
    display: inline-block;
    margin-left: 8px;
  }

  .loading-dots::after {
    content: '';
    animation: dots 1.5s steps(4, end) infinite;
  }

  @keyframes dots {
    0%, 20% { content: ''; }
    40% { content: '.'; }
    60% { content: '..'; }
    80%, 100% { content: '...'; }
  }

  /* ‚úÖ –°—Ç–∏–ª–∏ –¥–ª—è —É—Å–ø–µ—à–Ω—ã—Ö –ø–æ–ª–µ–π */
  .form-group.success input,
  .form-group.success textarea {
    border-color: #28a745;
    box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
  }

  /* üì± –£–ª—É—á—à–µ–Ω–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
  @media (max-width: 768px) {
    .total-amount-container {
      flex-direction: column;
      text-align: center;
    }

    .total-amount-label {
      margin-right: 0;
      margin-bottom: 10px;
    }
  }

  /* üé® –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ */
  .required-field {
    color: #dc3545;
    font-weight: bold;
  }

  .section-header {
    background: linear-gradient(135deg, #007bff, #6610f2);
    color: white;
    margin: -15px -15px 15px -15px;
    padding: 15px;
    border-radius: 8px 8px 0 0;
  }

  .form-control:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
  }

  /* üéØ –ü—Ä–æ—Å—Ç–∞—è –ø—É–ª—å—Å–∞—Ü–∏—è –≤–º–µ—Å—Ç–æ –≤—Ä–∞—â–µ–Ω–∏—è (–º–µ–Ω–µ–µ –Ω–∞–≤—è–∑—á–∏–≤–æ) */
  .btn-processing {
    animation: gentle-pulse 2s ease-in-out infinite;
  }

  @keyframes gentle-pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.8; }
  }
</style>

<section class="section-content padding-y">
    <div class="container">
        {% include 'base/alert.html' %}

        <!-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∫–æ—Ä–∑–∏–Ω–µ -->
        {% if not cart.cart_items.all %}
        <div class="card text-center">
            <div class="card-body py-5">
                <i class="fa fa-shopping-cart fa-3x text-muted mb-3"></i>
                <h4>–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</h4>
                <p class="text-muted">–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω—É, —á—Ç–æ–±—ã –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</p>
                <a href="{% url 'index' %}" class="btn btn-primary">
                    <i class="fa fa-arrow-left"></i> –ü–µ—Ä–µ–π—Ç–∏ –∫ –ø–æ–∫—É–ø–∫–∞–º
                </a>
            </div>
        </div>
        {% else %}

        <!-- –ë–ª–æ–∫ —Å —Ç–æ–≤–∞—Ä–∞–º–∏ –≤ –∫–æ—Ä–∑–∏–Ω–µ -->
        <div class="card mb-3">
            <div class="section-header">
                <h5 class="mb-0"><i class="fa fa-shopping-cart"></i> –¢–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω–µ</h5>
            </div>
            <table class="table table-borderless table-shopping-cart">
                <thead class="text-muted">
                    <tr class="small text-uppercase">
                        <th scope="col">–¢–æ–≤–∞—Ä</th>
                        <th scope="col" width="120">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                        <th scope="col" width="120">–¶–µ–Ω–∞</th>
                        <th scope="col" class="text-right" width="100">–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    {% for cart_item in cart.cart_items.all %}
                    <tr>
                        <td>
                            <figure class="itemside">
                                <div class="aside">
                                    {% if cart_item.kit_variant and cart_item.kit_variant.image %}
                                    <img src="{{ cart_item.kit_variant.image.url }}" class="img-sm"
                                        alt="{{ cart_item.kit_variant.name }}" />
                                    {% else %}
                                    <img src="/media/{{ cart_item.product.product_images.first.image }}"
                                        class="img-sm" alt="{{ cart_item.product.product_name }}" />
                                    {% endif %}
                                </div>
                                <figcaption class="info">
                                    <a href="{% url 'get_product' cart_item.product.slug %}"
                                        class="title text-dark">
                                        {{ cart_item.product.product_name }}
                                    </a>

                                    <p class="text-muted small mb-0">
                                        {% if cart_item.kit_variant %}
                                        <strong>–ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è:</strong> {{ cart_item.kit_variant.name }}<br />
                                        {% endif %}

                                        {% if cart_item.carpet_color %}
                                        <strong>–¶–≤–µ—Ç –∫–æ–≤—Ä–∏–∫–∞:</strong>
                                        <span
                                            style="display: inline-block; width: 12px; height: 12px; background-color: {{ cart_item.carpet_color.hex_code }}; border: 1px solid #ccc; border-radius: 2px;"></span>
                                        {{ cart_item.carpet_color.name }}<br />
                                        {% endif %}

                                        {% if cart_item.border_color %}
                                        <strong>–¶–≤–µ—Ç –æ–∫–∞–Ω—Ç–æ–≤–∫–∏:</strong>
                                        <span
                                            style="display: inline-block; width: 12px; height: 12px; background-color: {{ cart_item.border_color.hex_code }}; border: 1px solid #ccc; border-radius: 2px;"></span>
                                        {{ cart_item.border_color.name }}<br />
                                        {% endif %}

                                        {% if cart_item.has_podpyatnik %}
                                        <strong>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:</strong> –° –ø–æ–¥–ø—è—Ç–Ω–∏–∫–æ–º<br />
                                        {% endif %}
                                    </p>
                                </figcaption>
                            </figure>
                        </td>
                        <td>
                            <select class="form-control" title="–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ"
                                onchange="updateCartItem(this, '{{ cart_item.uid }}')">
                                {% for i in quantity_range %}
                                <option value="{{ i }}" {% if cart_item.quantity == i %}selected{% endif %}>
                                    {{ i }} —à—Ç.
                                </option>
                                {% endfor %}
                            </select>
                        </td>
                        <td>
                            <div class="price-wrap">
                                <var class="price font-weight-bold">{{ cart_item.get_product_price }} —Ä—É–±.</var>
                            </div>
                        </td>
                        <td class="text-right">
                            <a href="{% url 'remove_cart' cart_item.uid %}"
                               class="btn btn-danger btn-sm"
                               title="–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä"
                               onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã?')">
                                <i class="fa fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <!-- –ë–ª–æ–∫ —Å –∫–Ω–æ–ø–∫–æ–π –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∫—É–ø–∫–∏ -->
            <div class="card-body border-top">
                <a href="{% url 'index' %}" class="btn btn-outline-primary">
                    <i class="fa fa-chevron-left"></i> –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∫—É–ø–∫–∏
                </a>
            </div>
        </div>

        <!-- –ë–ª–æ–∫ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –¥–æ—Å—Ç–∞–≤–∫–µ -->
        <div class="card mb-3">
            <div class="card-body bg-light">
                <div class="d-flex align-items-center">
                    <i class="fa fa-truck text-success mr-3 fa-2x"></i>
                    <div>
                        <h6 class="mb-1">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ—Å—Ç–∞–≤–∫–µ</h6>
                        <p class="mb-0 text-muted">
                            –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ –ø—Ä–µ–¥–æ–ø–ª–∞—Ç–µ –∏–ª–∏ –Ω–∞–ª–æ–∂–µ–Ω–Ω—ã–º –ø–ª–∞—Ç–µ–∂–æ–º.
                            –°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤–µ—Å–∞ –∏ –¥–∞–ª—å–Ω–æ—Å—Ç–∏ —Ä–µ–≥–∏–æ–Ω–∞ –†–ë.
                            <strong>–°—Ä–æ–∫–∏ –¥–æ—Å—Ç–∞–≤–∫–∏: 2-3 –¥–Ω—è.</strong>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- –§–û–†–ú–ê –û–§–û–†–ú–õ–ï–ù–ò–Ø –ó–ê–ö–ê–ó–ê -->
        <div class="card mb-4">
            <div class="section-header">
                <h5 class="mb-0"><i class="fa fa-file-text"></i> –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h5>
            </div>
            <div class="card-body">
                <!-- üö® –ë–ª–æ–∫ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ–±—â–∏—Ö –æ—à–∏–±–æ–∫ -->
                <div id="form-errors" class="alert alert-danger" style="display: none;">
                    <strong><i class="fa fa-exclamation-triangle"></i> –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –æ—à–∏–±–∫–∏:</strong>
                    <ul id="error-list" class="mb-0 mt-2"></ul>
                </div>

                <form method="POST" action="{% url 'place_order' %}" id="orderForm">
                    {% csrf_token %}

                    <!-- –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group" id="name-group">
                                <label for="customer_name">
                                    <i class="fa fa-user text-primary"></i> –í–∞—à–µ –∏–º—è
                                    <span class="required-field">*</span>
                                </label>
                                <input type="text" class="form-control" id="customer_name" name="customer_name"
                                       required maxlength="100" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è"
                                       title="–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ">
                                <div class="error-message" id="name-error"></div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group" id="phone-group">
                                <label for="customer_phone">
                                    <i class="fa fa-phone text-primary"></i> –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω
                                    <span class="required-field">*</span>
                                </label>
                                <input type="tel" class="form-control" id="customer_phone" name="customer_phone"
                                       required placeholder="+375 XX XXX XX XX"
                                       title="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è —Å–≤—è–∑–∏">
                                <div class="error-message" id="phone-error"></div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group" id="city-group">
                        <label for="customer_city">
                            <i class="fa fa-map-marker text-primary"></i> –í–∞—à –≥–æ—Ä–æ–¥
                            <span class="required-field">*</span>
                        </label>
                        <input type="text" class="form-control" id="customer_city" name="customer_city"
                               required maxlength="100" placeholder="–£–∫–∞–∂–∏—Ç–µ –≤–∞—à –≥–æ—Ä–æ–¥"
                               title="–ì–æ—Ä–æ–¥ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏">
                        <div class="error-message" id="city-error"></div>
                    </div>

                    <!-- –ß–µ–∫–±–æ–∫—Å –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏ -->
                    <div class="custom-checkbox-container">
                        <input type="checkbox" id="need_delivery" name="need_delivery"
                               onclick="toggleDeliverySection()">
                        <label for="need_delivery" class="font-weight-bold">
                            üöö –ù—É–∂–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∞ (–æ–ø–ª–∞—á–∏–≤–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ)
                        </label>
                    </div>

                    <!-- –°–∫—Ä—ã–≤–∞–µ–º–∞—è —Å–µ–∫—Ü–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏ -->
                    <div id="deliverySection" class="delivery-section">
                        <h6 class="text-primary mb-3">
                            <i class="fa fa-truck"></i> –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–æ—Å—Ç–∞–≤–∫–∏
                        </h6>

                        <!-- –°–ø–æ—Å–æ–± –¥–æ—Å—Ç–∞–≤–∫–∏ -->
                        <div class="form-group">
                            <label class="font-weight-bold">
                                –°–ø–æ—Å–æ–± –¥–æ—Å—Ç–∞–≤–∫–∏ <span class="required-field">*</span>
                            </label>
                            <div class="custom-control custom-radio mb-2">
                                <input type="radio" id="delivery_europochta" name="delivery_method"
                                       value="europochta" class="custom-control-input" checked>
                                <label class="custom-control-label" for="delivery_europochta">
                                    <strong>–ï–≤—Ä–æ–ø–æ—á—Ç–∞ –ø–æ –ë–µ–ª–∞—Ä—É—Å–∏</strong>
                                    <small class="text-muted d-block">–ë—ã—Å—Ç—Ä–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ –≤ –æ—Ç–¥–µ–ª–µ–Ω–∏—è</small>
                                </label>
                            </div>
                            <div class="custom-control custom-radio mb-2">
                                <input type="radio" id="delivery_belpochta" name="delivery_method"
                                       value="belpochta" class="custom-control-input">
                                <label class="custom-control-label" for="delivery_belpochta">
                                    <strong>–ë–µ–ª–ø–æ—á—Ç–∞ –ø–æ –ë–µ–ª–∞—Ä—É—Å–∏</strong>
                                    <small class="text-muted d-block">–î–æ—Å—Ç–∞–≤–∫–∞ –≤ –ø–æ—á—Ç–æ–≤—ã–µ –æ—Ç–¥–µ–ª–µ–Ω–∏—è</small>
                                </label>
                            </div>
                            <div class="custom-control custom-radio">
                                <input type="radio" id="delivery_yandex" name="delivery_method"
                                       value="yandex" class="custom-control-input">
                                <label class="custom-control-label" for="delivery_yandex">
                                    <strong>–Ø–Ω–¥–µ–∫—Å –∫—É—Ä—å–µ—Ä –ø–æ –ú–∏–Ω—Å–∫—É</strong>
                                    <small class="text-muted d-block">–î–æ—Å—Ç–∞–≤–∫–∞ –∫—É—Ä—å–µ—Ä–æ–º –¥–æ –¥–≤–µ—Ä–∏</small>
                                </label>
                            </div>
                        </div>

                        <!-- –ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ -->
                        <div class="form-group" id="address-group">
                            <label for="shipping_address">
                                <i class="fa fa-map text-primary"></i> –ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏
                                <span class="required-field">*</span>
                            </label>
                            <textarea class="form-control" id="shipping_address" name="shipping_address" rows="3"
                                placeholder="–î–ª—è –ï–≤—Ä–æ–ø–æ—á—Ç—ã/–ë–µ–ª–ø–æ—á—Ç—ã: —É–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä –æ—Ç–¥–µ–ª–µ–Ω–∏—è –∏ –≥–æ—Ä–æ–¥&#10;–î–ª—è –∫—É—Ä—å–µ—Ä–∞: –ø–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å –≤ –ú–∏–Ω—Å–∫–µ —Å –ø–æ–¥—ä–µ–∑–¥–æ–º –∏ –∫–≤–∞—Ä—Ç–∏—Ä–æ–π"></textarea>
                            <div class="error-message" id="address-error"></div>
                        </div>
                    </div>

                    <!-- –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ –∫ –∑–∞–∫–∞–∑—É -->
                    <div class="form-group">
                        <label for="order_notes">
                            <i class="fa fa-comment text-primary"></i> –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ –∫ –∑–∞–∫–∞–∑—É
                        </label>
                        <textarea class="form-control" id="order_notes" name="order_notes" rows="2"
                                  placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è, —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –∑–≤–æ–Ω–∫–∞ –∏ –¥—Ä—É–≥–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"
                                  title="–õ—é–±—ã–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è"></textarea>
                        <small class="text-muted">–£–∫–∞–∂–∏—Ç–µ —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –∑–≤–æ–Ω–∫–∞ –∏–ª–∏ –æ—Å–æ–±—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è</small>
                    </div>

                    <!-- –°–æ–≥–ª–∞—Å–∏–µ —Å —É—Å–ª–æ–≤–∏—è–º–∏ -->
                    <div class="custom-checkbox-container" id="terms-group">
                        <input type="checkbox" id="terms_agree" name="terms_agree" required>
                        <label for="terms_agree">
                            –û—Ñ–æ—Ä–º–ª—è—è –∑–∞–∫–∞–∑, —è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é —Å–≤–æ–µ —Å–æ–≥–ª–∞—Å–∏–µ —Å
                            <a href="/terms/" target="_blank" class="text-primary">–£—Å–ª–æ–≤–∏—è–º–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–∞–π—Ç–∞</a> –∏
                            <a href="/return-policy/" target="_blank" class="text-primary">–£—Å–ª–æ–≤–∏—è–º–∏ –≤–æ–∑–≤—Ä–∞—Ç–∞ —Ç–æ–≤–∞—Ä–∞</a>
                            <span class="required-field">*</span>
                        </label>
                        <div class="error-message" id="terms-error"></div>
                    </div>

                    <!-- –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å -->
                    <div class="total-amount-container">
                        <span class="total-amount-label">
                            <i class="fa fa-calculator"></i> –ò–¢–û–ì–û –ö –û–ü–õ–ê–¢–ï:
                        </span>
                        <span class="total-amount-value" id="total-amount">
                            {{ cart.get_cart_total }} —Ä—É–±.
                        </span>
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ –ë–ï–ó –í–†–ê–©–ê–Æ–©–ï–ì–û–°–Ø –°–ü–ò–ù–ù–ï–†–ê -->
                    <button type="submit" class="btn btn-success btn-block btn-lg" id="placeOrderBtn">
                        <span id="btn-text">
                            <i class="fa fa-check-circle"></i> –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑
                        </span>
                        <span id="btn-loading" style="display: none;">
                            <i class="fa fa-clock-o"></i> –û—Ñ–æ—Ä–º–ª—è–µ–º –∑–∞–∫–∞–∑<span class="loading-dots"></span>
                        </span>
                    </button>

                    <p class="text-center text-muted mt-3 mb-0">
                        <small>
                            <i class="fa fa-shield"></i>
                            –ü–æ—Å–ª–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ —Å –≤–∞–º–∏ —Å–≤—è–∂–µ—Ç—Å—è –Ω–∞—à –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
                        </small>
                    </p>
                </form>
            </div>
        </div>
        {% endif %}
    </div>
</section>

<script>
    console.log('üõí –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–æ–∫–æ–π–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –∫–æ—Ä–∑–∏–Ω—ã –ë–ï–ó –≤—Ä–∞—â–µ–Ω–∏–π...');

    // üîß –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Å–µ–∫—Ü–∏–∏ –¥–æ—Å—Ç–∞–≤–∫–∏
    function toggleDeliverySection() {
        const deliverySection = document.getElementById('deliverySection');
        const needDelivery = document.getElementById('need_delivery').checked;
        const addressField = document.getElementById('shipping_address');

        console.log('üöö –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –¥–æ—Å—Ç–∞–≤–∫–∏:', needDelivery);

        if (needDelivery) {
            deliverySection.classList.add('active');
            addressField.setAttribute('required', 'required');
            console.log('‚úÖ –°–µ–∫—Ü–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞');
        } else {
            deliverySection.classList.remove('active');
            addressField.removeAttribute('required');
            clearFieldError('address-group');
            console.log('‚ùå –°–µ–∫—Ü–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞');
        }
    }

    // üîÑ –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–∞
    function updateCartItem(selectElement, cartItemId) {
        const quantity = selectElement.value.replace(' —à—Ç.', ''); // –£–±–∏—Ä–∞–µ–º "—à—Ç."
        console.log('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞:', cartItemId, '–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ:', quantity);

        fetch("{% url 'update_cart_item' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({
                "cart_item_id": cartItemId,
                "quantity": parseInt(quantity)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('‚úÖ –¢–æ–≤–∞—Ä –æ–±–Ω–æ–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ');
                window.location.reload();
            } else {
                console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', data.error);
                alert("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ—Ä–∑–∏–Ω—ã: " + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        })
        .catch(error => {
            console.error('‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏:', error);
            alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ—Ä–∑–∏–Ω—ã");
        });
    }

    // üßπ –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ –æ—à–∏–±–æ–∫ –ø–æ–ª—è
    function clearFieldError(groupId) {
        const group = document.getElementById(groupId);
        if (group) {
            group.classList.remove('error');
            group.classList.remove('success');
            const errorMessage = group.querySelector('.error-message');
            if (errorMessage) {
                errorMessage.textContent = '';
            }
        }
    }

    // ‚ùå –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—à–∏–±–∫–∏ –ø–æ–ª—è
    function showFieldError(groupId, message) {
        const group = document.getElementById(groupId);
        if (group) {
            group.classList.add('error');
            group.classList.remove('success');
            const errorMessage = group.querySelector('.error-message');
            if (errorMessage) {
                errorMessage.textContent = message;
            }
        }
    }

    // ‚úÖ –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —É—Å–ø–µ—Ö–∞ –ø–æ–ª—è
    function showFieldSuccess(groupId) {
        const group = document.getElementById(groupId);
        if (group) {
            group.classList.add('success');
            group.classList.remove('error');
            const errorMessage = group.querySelector('.error-message');
            if (errorMessage) {
                errorMessage.textContent = '';
            }
        }
    }

    // üì± –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    function validatePhone(phone) {
        const phoneRegex = /^[\+]?[0-9\s\-\(\)]{7,15}$/;
        return phoneRegex.test(phone);
    }

    // üèôÔ∏è –í–∞–ª–∏–¥–∞—Ü–∏—è –≥–æ—Ä–æ–¥–∞
    function validateCity(city) {
        return city.length >= 2 && city.length <= 100;
    }

    // üîç –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ñ–æ—Ä–º—ã
    function validateForm() {
        console.log('üîç –ù–∞—á–∏–Ω–∞–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏—é —Ñ–æ—Ä–º—ã...');

        let isValid = true;
        const errors = [];

        // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ–ª–µ–π
        const name = document.getElementById('customer_name').value.trim();
        const phone = document.getElementById('customer_phone').value.trim();
        const city = document.getElementById('customer_city').value.trim();
        const needDelivery = document.getElementById('need_delivery').checked;
        const termsAgree = document.getElementById('terms_agree').checked;
        const address = document.getElementById('shipping_address').value.trim();

        console.log('üìù –î–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã:', { name, phone, city, needDelivery, termsAgree });

        // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ—à–∏–±–∫–∏
        ['name-group', 'phone-group', 'city-group', 'address-group', 'terms-group'].forEach(clearFieldError);

        // –í–∞–ª–∏–¥–∞—Ü–∏—è –∏–º–µ–Ω–∏
        if (!name) {
            showFieldError('name-group', '–ü–æ–ª–µ "–ò–º—è" –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è');
            errors.push('–ù–µ —É–∫–∞–∑–∞–Ω–æ –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞');
            isValid = false;
        } else if (name.length < 2) {
            showFieldError('name-group', '–ò–º—è –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞');
            errors.push('–ò–º—è —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ');
            isValid = false;
        } else {
            showFieldSuccess('name-group');
        }

        // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        if (!phone) {
            showFieldError('phone-group', '–ü–æ–ª–µ "–¢–µ–ª–µ—Ñ–æ–Ω" –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è');
            errors.push('–ù–µ —É–∫–∞–∑–∞–Ω –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω');
            isValid = false;
        } else if (!validatePhone(phone)) {
            showFieldError('phone-group', '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞');
            errors.push('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞');
            isValid = false;
        } else {
            showFieldSuccess('phone-group');
        }

        // –í–∞–ª–∏–¥–∞—Ü–∏—è –≥–æ—Ä–æ–¥–∞
        if (!city) {
            showFieldError('city-group', '–ü–æ–ª–µ "–ì–æ—Ä–æ–¥" –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è');
            errors.push('–ù–µ —É–∫–∞–∑–∞–Ω –≥–æ—Ä–æ–¥');
            isValid = false;
        } else if (!validateCity(city)) {
            showFieldError('city-group', '–ù–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –æ—Ç 2 –¥–æ 100 —Å–∏–º–≤–æ–ª–æ–≤');
            errors.push('–ù–µ–≤–µ—Ä–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞');
            isValid = false;
        } else {
            showFieldSuccess('city-group');
        }

        // –í–∞–ª–∏–¥–∞—Ü–∏—è —É—Å–ª–æ–≤–∏–π
        if (!termsAgree) {
            showFieldError('terms-group', '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–≥–ª–∞—Å–∏—Ç—å—Å—è —Å —É—Å–ª–æ–≤–∏—è–º–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–∞–π—Ç–∞');
            errors.push('–ù–µ –¥–∞–Ω–æ —Å–æ–≥–ª–∞—Å–∏–µ —Å —É—Å–ª–æ–≤–∏—è–º–∏');
            isValid = false;
        }

        // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–ª–µ–π –¥–æ—Å—Ç–∞–≤–∫–∏
        if (needDelivery) {
            if (!address) {
                showFieldError('address-group', '–ü—Ä–∏ –≤—ã–±–æ—Ä–µ –¥–æ—Å—Ç–∞–≤–∫–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –∞–¥—Ä–µ—Å');
                errors.push('–ù–µ —É–∫–∞–∑–∞–Ω –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏');
                isValid = false;
            } else if (address.length < 10) {
                showFieldError('address-group', '–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω—ã–º');
                errors.push('–°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏');
                isValid = false;
            } else {
                showFieldSuccess('address-group');
            }
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—â–∏–µ –æ—à–∏–±–∫–∏
        const formErrors = document.getElementById('form-errors');
        const errorList = document.getElementById('error-list');

        if (!isValid) {
            errorList.innerHTML = errors.map(error => `<li>${error}</li>`).join('');
            formErrors.style.display = 'block';
            formErrors.scrollIntoView({ behavior: 'smooth', block: 'center' });
            console.log('‚ùå –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–∞:', errors);
        } else {
            formErrors.style.display = 'none';
            console.log('‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ');
        }

        return isValid;
    }

    // üéØ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ –≤–≤–æ–¥–µ
    document.addEventListener('DOMContentLoaded', function() {
        const formFields = [
            { id: 'customer_name', group: 'name-group' },
            { id: 'customer_phone', group: 'phone-group' },
            { id: 'customer_city', group: 'city-group' },
            { id: 'shipping_address', group: 'address-group' }
        ];

        formFields.forEach(field => {
            const element = document.getElementById(field.id);
            if (element) {
                element.addEventListener('input', function() {
                    // –û—á–∏—â–∞–µ–º –æ—à–∏–±–∫—É –ø—Ä–∏ –Ω–∞—á–∞–ª–µ –≤–≤–æ–¥–∞
                    clearFieldError(field.group);

                    // –°–∫—Ä—ã–≤–∞–µ–º –æ–±—â–∏–µ –æ—à–∏–±–∫–∏
                    if (this.value.trim()) {
                        document.getElementById('form-errors').style.display = 'none';
                    }
                });
            }
        });

        console.log('üéØ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞');
    });

    // üìù –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã - –£–ë–†–ê–õ–ò –í–†–ê–©–ï–ù–ò–ï!
    document.getElementById('orderForm').addEventListener('submit', function(e) {
        console.log('üìù –ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã –∑–∞–∫–∞–∑–∞...');

        // –ü—Ä–æ–≤–æ–¥–∏–º –≤–∞–ª–∏–¥–∞—Ü–∏—é
        if (!validateForm()) {
            e.preventDefault();
            console.log('‚ùå –§–æ—Ä–º–∞ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∏–∑-–∑–∞ –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏');
            return false;
        }

        console.log('‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É');

        // üéØ –°–ü–û–ö–û–ô–ù–ê–Ø –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ë–ï–ó –í–†–ê–©–ï–ù–ò–Ø
        const btn = document.getElementById('placeOrderBtn');
        const btnText = document.getElementById('btn-text');
        const btnLoading = document.getElementById('btn-loading');

        btn.disabled = true;
        btn.classList.add('btn-processing'); // –ú—è–≥–∫–∞—è –ø—É–ª—å—Å–∞—Ü–∏—è
        btnText.style.display = 'none';
        btnLoading.style.display = 'inline';

        console.log('üîí –ö–Ω–æ–ø–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞, –ø–æ–∫–∞–∑–∞–Ω–æ –°–ü–û–ö–û–ô–ù–û–ï —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏');

        // –¢–∞–π–º–∞—É—Ç –¥–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (–Ω–∞ —Å–ª—É—á–∞–π –æ—à–∏–±–∫–∏)
        setTimeout(() => {
            if (btn.disabled) {
                btn.disabled = false;
                btn.classList.remove('btn-processing');
                btnText.style.display = 'inline';
                btnLoading.style.display = 'none';
                console.log('‚è∞ –ö–Ω–æ–ø–∫–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ –ø–æ —Ç–∞–π–º–∞—É—Ç—É');
            }
        }, 15000); // 15 —Å–µ–∫—É–Ω–¥

        return true;
    });

    console.log('‚úÖ –°–ø–æ–∫–æ–π–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –∫–æ—Ä–∑–∏–Ω—ã –ë–ï–ó –≤—Ä–∞—â–µ–Ω–∏–π –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ');
</script>
{% endblock %}