<!-- üìÅ templates/product/all_product_reviews.html - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø -->
<!-- ‚úÖ –§–ò–ö–°: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ _cached_product –≤–º–µ—Å—Ç–æ review.product –¥–ª—è Generic FK -->
<!-- üîß –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç –æ—à–∏–±–æ–∫ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ —Ç–æ–≤–∞—Ä—É -->

{% extends 'base.html' %}
{% load static %}

{% block title %}–ú–æ–∏ –æ—Ç–∑—ã–≤—ã{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="fas fa-star me-2"></i>
                –ú–æ–∏ –æ—Ç–∑—ã–≤—ã
            </h2>

            {% if reviews %}
            <div class="row">
                {% for review in reviews %}
                <div class="col-12 mb-4">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <!-- üìù –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ -->
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    {% if review._cached_product %}
                                        <!-- ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º _cached_product -->
                                        <h5 class="card-title">
                                            <a href="{% if review._cached_product.slug %}/products/{{ review._cached_product.slug }}/{% else %}#{% endif %}" 
                                               class="text-decoration-none">
                                                {{ review._cached_product.product_name|default:"–¢–æ–≤–∞—Ä" }}
                                            </a>
                                        </h5>
                                        {% if review._cached_product.category %}
                                        <small class="text-muted">
                                            <i class="fas fa-tag me-1"></i>
                                            {{ review._cached_product.category.category_name }}
                                        </small>
                                        {% endif %}
                                    {% else %}
                                        <!-- üîÑ –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω -->
                                        <h5 class="card-title text-muted">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            –¢–æ–≤–∞—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                                        </h5>
                                        <small class="text-muted">–í–æ–∑–º–æ–∂–Ω–æ, —Ç–æ–≤–∞—Ä –±—ã–ª —É–¥–∞–ª–µ–Ω</small>
                                    {% endif %}
                                </div>
                                
                                <!-- ‚≠ê –†–µ–π—Ç–∏–Ω–≥ -->
                                <div class="text-end">
                                    <div class="mb-2">
                                        {% for i in "12345" %}
                                            {% if i|add:0 <= review.stars %}
                                                <i class="fas fa-star text-warning"></i>
                                            {% else %}
                                                <i class="far fa-star text-muted"></i>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                    <small class="text-muted">
                                        <i class="fas fa-calendar-alt me-1"></i>
                                        {{ review.date_added|date:"d.m.Y" }}
                                    </small>
                                </div>
                            </div>

                            <!-- üí¨ –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –æ—Ç–∑—ã–≤–∞ -->
                            {% if review.content %}
                            <div class="mb-3">
                                <p class="card-text">{{ review.content }}</p>
                            </div>
                            {% endif %}

                            <!-- üëçüëé –õ–∞–π–∫–∏/–¥–∏–∑–ª–∞–π–∫–∏ -->
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex gap-3">
                                    <span class="text-muted">
                                        <i class="fas fa-thumbs-up me-1"></i>
                                        {{ review.like_count }}
                                    </span>
                                    <span class="text-muted">
                                        <i class="fas fa-thumbs-down me-1"></i>
                                        {{ review.dislike_count }}
                                    </span>
                                </div>

                                <!-- üîß –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
                                <div class="btn-group" role="group">
                                    {% if review._cached_product and review._cached_product.slug %}
                                    <!-- ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ slug -->
                                    <button
                                        class="btn btn-outline-primary btn-sm"
                                        type="button"
                                        data-bs-toggle="modal"
                                        data-bs-target="#editReviewModal"
                                        onclick="setEditReview('{{ review.uid }}', '{{ review.stars }}', '{{ review.content|escapejs }}')"
                                    >
                                        <i class="fas fa-edit me-1"></i>
                                        –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                                    </button>
                                    
                                    <button
                                        class="btn btn-outline-danger btn-sm"
                                        data-bs-toggle="modal"
                                        data-bs-target="#deleteReviewModal"
                                        onclick="setDeleteAction('{% url 'delete_review' review._cached_product.slug review.uid %}')"
                                        type="button"
                                    >
                                        <i class="fas fa-trash me-1"></i>
                                        –£–¥–∞–ª–∏—Ç—å
                                    </button>
                                    {% else %}
                                    <!-- üö´ –ï—Å–ª–∏ –Ω–µ—Ç slug, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —É–¥–∞–ª–µ–Ω–∏–µ -->
                                    <button
                                        class="btn btn-outline-danger btn-sm"
                                        onclick="if(confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –æ—Ç–∑—ã–≤?')) { 
                                            fetch('/admin/common/productreview/{{ review.uid }}/delete/', {method: 'POST'}); 
                                            location.reload(); 
                                        }"
                                        type="button"
                                    >
                                        <i class="fas fa-trash me-1"></i>
                                        –£–¥–∞–ª–∏—Ç—å
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <!-- üì≠ –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
            <div class="text-center py-5">
                <i class="fas fa-comment-slash fa-3x text-muted mb-3"></i>
                <h4 class="text-muted">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤</h4>
                <p class="text-muted">–û—Å—Ç–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π –æ—Ç–∑—ã–≤ –æ —Ç–æ–≤–∞—Ä–µ, –∫–æ—Ç–æ—Ä—ã–π –≤—ã –ø—Ä–∏–æ–±—Ä–µ–ª–∏!</p>
                <a href="{% url 'products_catalog' %}" class="btn btn-primary">
                    <i class="fas fa-shopping-bag me-2"></i>
                    –ü–µ—Ä–µ–π—Ç–∏ –∫ –ø–æ–∫—É–ø–∫–∞–º
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- üóëÔ∏è –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–¥–∞–ª–µ–Ω–∏—è –æ—Ç–∑—ã–≤–∞ -->
<div class="modal fade" id="deleteReviewModal" tabindex="-1" aria-labelledby="deleteReviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteReviewModalLabel">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                    –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É–¥–∞–ª–µ–Ω–∏–µ
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –æ—Ç–∑—ã–≤?</p>
                <p class="text-muted small">–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>
                    –û—Ç–º–µ–Ω–∞
                </button>
                <form id="deleteReviewForm" method="POST" style="display: inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-1"></i>
                        –£–¥–∞–ª–∏—Ç—å –æ—Ç–∑—ã–≤
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- ‚úèÔ∏è –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–∑—ã–≤–∞ -->
<div class="modal fade" id="editReviewModal" tabindex="-1" aria-labelledby="editReviewModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editReviewModalLabel">
                    <i class="fas fa-edit me-2"></i>
                    –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–∑—ã–≤
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editReviewForm" method="POST">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editStars" class="form-label">–û—Ü–µ–Ω–∫–∞:</label>
                        <select name="stars" id="editStars" class="form-select" required>
                            <option value="1">1 - –û—á–µ–Ω—å –ø–ª–æ—Ö–æ</option>
                            <option value="2">2 - –ü–ª–æ—Ö–æ</option>
                            <option value="3">3 - –ù–æ—Ä–º–∞–ª—å–Ω–æ</option>
                            <option value="4">4 - –•–æ—Ä–æ—à–æ</option>
                            <option value="5">5 - –û—Ç–ª–∏—á–Ω–æ</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editContent" class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</label>
                        <textarea name="content" id="editContent" class="form-control" rows="4" 
                                  placeholder="–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –≤–∞—à–∏–º –º–Ω–µ–Ω–∏–µ–º –æ —Ç–æ–≤–∞—Ä–µ..." required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>
                        –û—Ç–º–µ–Ω–∞
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// üóëÔ∏è –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–µ–π—Å—Ç–≤–∏—è —É–¥–∞–ª–µ–Ω–∏—è
function setDeleteAction(url) {
    document.getElementById('deleteReviewForm').action = url;
}

// ‚úèÔ∏è –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
function setEditReview(reviewUid, stars, content) {
    document.getElementById('editReviewForm').action = `/products/product-reviews/edit/${reviewUid}/`;
    document.getElementById('editStars').value = stars;
    document.getElementById('editContent').value = content;
}
</script>
{% endblock %}