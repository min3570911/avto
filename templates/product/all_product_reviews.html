<!-- üìÅ templates/product/all_product_reviews.html - –ü–£–ë–õ–ò–ß–ù–ê–Ø –°–¢–†–ê–ù–ò–¶–ê –í–°–ï–• –û–¢–ó–´–í–û–í -->
<!-- üåü –û–ë–ù–û–í–õ–ï–ù–û: –ü–æ–∫–∞–∑ –≤—Å–µ—Ö –æ–¥–æ–±—Ä–µ–Ω–Ω—ã—Ö –æ—Ç–∑—ã–≤–æ–≤ —Å–æ –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤ -->
<!-- üìä –î–û–ë–ê–í–õ–ï–ù–û: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, —Ñ–∏–ª—å—Ç—Ä—ã –∏ –∫—Ä–∞—Å–∏–≤–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ -->

{% extends 'base/base.html' %}
{% load static %}
{% load review_extras %}

<!-- üîê CSRF —Ç–æ–∫–µ–Ω –¥–ª—è AJAX –∑–∞–ø—Ä–æ—Å–æ–≤ -->
{% csrf_token %}

{% block title %}–û—Ç–∑—ã–≤—ã –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π | –í—Å–µ –æ—Ç–∑—ã–≤—ã –æ —Ç–æ–≤–∞—Ä–∞—Ö{% endblock %}

{% block start %}
<div class="container my-5">
    <!-- üìù –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="text-center mb-4">
                <h1 class="display-4 mb-3">
                    <i class="fas fa-star text-warning me-3"></i>
                    –û—Ç–∑—ã–≤—ã –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π
                </h1>
                <p class="lead text-muted">
                    –ß–µ—Å—Ç–Ω—ã–µ –æ—Ç–∑—ã–≤—ã –Ω–∞—à–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –æ —Ç–æ–≤–∞—Ä–∞—Ö
                </p>
            </div>
        </div>
    </div>

    <!-- üìù –û—Ç–∑—ã–≤—ã -->
    <div class="row">
        <div class="col-12">
            {% if reviews %}
                <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è —Å–≤–µ—Ä—Ö—É -->
                {% if page_obj.has_other_pages %}
                <nav aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –æ—Ç–∑—ã–≤–∞–º">
                    <ul class="pagination justify-content-center mb-4">
                        {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}">–ù–∞–∑–∞–¥</a>
                        </li>
                        {% endif %}

                        <li class="page-item active">
                            <span class="page-link">{{ page_obj.number }} –∏–∑ {{ page_obj.paginator.num_pages }}</span>
                        </li>

                        {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}">–í–ø–µ—Ä–µ–¥</a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}

                <!-- –°–ø–∏—Å–æ–∫ –æ—Ç–∑—ã–≤–æ–≤ -->
                <div class="row">
                    {% for review in reviews %}
                    <div class="col-12 mb-4">
                        <div class="card border review-card">
                            <div class="card-body">
                                <div class="row">
                                    <!-- üñºÔ∏è –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–û–ï –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ï –¢–û–í–ê–†–ê -->
                                    <div class="col-md-2 col-3">
                                        {% if review.cached_product %}
                                            {% if review.product_type == 'product' %}
                                                <!-- üöó –ê–≤—Ç–æ–º–æ–±–∏–ª—å–Ω—ã–µ –∫–æ–≤—Ä–∏–∫–∏ -->
                                                {% if review.cached_product.product_images.all %}
                                                    <img src="{{ review.cached_product.product_images.first.image.url }}"
                                                         alt="{{ review.cached_product.product_name }}"
                                                         class="img-fluid rounded product-image">
                                                {% else %}
                                                    <div class="no-image-placeholder d-flex align-items-center justify-content-center">
                                                        <i class="fas fa-car fa-2x text-muted"></i>
                                                    </div>
                                                {% endif %}
                                            {% elif review.product_type == 'boat' %}
                                                <!-- üõ•Ô∏è –õ–æ–¥–æ—á–Ω—ã–µ –∫–æ–≤—Ä–∏–∫–∏ -->
                                                {% if review.cached_product.images.all %}
                                                    <img src="{{ review.cached_product.images.first.image.url }}"
                                                         alt="{{ review.cached_product.product_name }}"
                                                         class="img-fluid rounded product-image">
                                                {% else %}
                                                    <div class="no-image-placeholder d-flex align-items-center justify-content-center">
                                                        <i class="fas fa-ship fa-2x text-muted"></i>
                                                    </div>
                                                {% endif %}
                                            {% else %}
                                                <!-- ‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —Ç–æ–≤–∞—Ä–∞ -->
                                                <div class="no-image-placeholder d-flex align-items-center justify-content-center">
                                                    <i class="fas fa-box fa-2x text-muted"></i>
                                                </div>
                                            {% endif %}
                                        {% else %}
                                            <div class="no-image-placeholder d-flex align-items-center justify-content-center">
                                                <i class="fas fa-exclamation-triangle fa-2x text-muted"></i>
                                            </div>
                                        {% endif %}
                                    </div>

                                    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
                                    <div class="col-md-10 col-9">
                                        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∞–≤—Ç–æ—Ä–æ–º –∏ —Ä–µ–π—Ç–∏–Ω–≥–æ–º -->
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div>
                                                <h6 class="mb-1 text-primary">
                                                    <i class="fas fa-user-circle me-1"></i>
                                                    {{ review.get_author_name }}
                                                </h6>
                                                <small class="text-muted">
                                                    <i class="fas fa-calendar-alt me-1"></i>
                                                    {{ review.date_added|date:"d.m.Y –≤ H:i" }}
                                                </small>
                                            </div>
                                            <!-- –†–µ–π—Ç–∏–Ω–≥ -->
                                            <div class="text-end">
                                                {% for i in "12345" %}
                                                    {% if i|add:0 <= review.stars %}
                                                        <i class="fas fa-star text-warning"></i>
                                                    {% else %}
                                                        <i class="far fa-star text-muted"></i>
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                        </div>

                                        <!-- üîó –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–û–ï –ù–ê–ó–í–ê–ù–ò–ï –¢–û–í–ê–†–ê -->
                                        {% if review.cached_product %}
                                        <h6 class="mb-2">
                                            <a href="{% if review.product_type == 'product' %}/products/{{ review.cached_product.slug }}/{% elif review.product_type == 'boat' %}/boats/product/{{ review.cached_product.slug }}/{% else %}#{% endif %}"
                                               class="text-decoration-none text-dark">
                                                {% if review.product_type == 'boat' %}
                                                    üõ•Ô∏è {{ review.cached_product.product_name|default:"–õ–æ–¥–æ—á–Ω—ã–π —Ç–æ–≤–∞—Ä" }}
                                                {% else %}
                                                    üöó {{ review.cached_product.product_name|default:"–ê–≤—Ç–æ–º–æ–±–∏–ª—å–Ω—ã–π —Ç–æ–≤–∞—Ä" }}
                                                {% endif %}
                                            </a>
                                        </h6>
                                        {% if review.cached_product.category %}
                                        <small class="text-muted d-block mb-2">
                                            <i class="fas fa-tag me-1"></i>
                                            {{ review.cached_product.category.category_name }}
                                        </small>
                                        {% endif %}
                                        {% else %}
                                        <h6 class="mb-2 text-muted">
                                            <i class="fas fa-exclamation-triangle me-1"></i>
                                            –¢–æ–≤–∞—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                                        </h6>
                                        {% endif %}

                                        <!-- –¢–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞ -->
                                        {% if review.content %}
                                        <p class="mb-3">{{ review.content }}</p>
                                        {% endif %}

                                        <!-- –õ–∞–π–∫–∏ –∏ —Å—Å—ã–ª–∫–∞ –Ω–∞ —Ç–æ–≤–∞—Ä -->
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="d-flex gap-3">
                                                {% if user.is_authenticated %}
                                                <button class="btn btn-outline-success btn-sm like-btn"
                                                        data-review-id="{{ review.uid }}"
                                                        data-action="like">
                                                    <i class="fas fa-thumbs-up me-1"></i>
                                                    <span class="like-count">{{ review.like_count }}</span>
                                                </button>
                                                <button class="btn btn-outline-danger btn-sm dislike-btn"
                                                        data-review-id="{{ review.uid }}"
                                                        data-action="dislike">
                                                    <i class="fas fa-thumbs-down me-1"></i>
                                                    <span class="dislike-count">{{ review.dislike_count }}</span>
                                                </button>
                                                {% else %}
                                                <span class="text-muted small">
                                                    <i class="fas fa-thumbs-up me-1 text-success"></i>
                                                    {{ review.like_count }}
                                                </span>
                                                <span class="text-muted small">
                                                    <i class="fas fa-thumbs-down me-1 text-danger"></i>
                                                    {{ review.dislike_count }}
                                                </span>
                                                {% endif %}
                                            </div>

                                            {% if review.cached_product and review.cached_product.slug %}
                                            <a href="{% if review.product_type == 'product' %}/products/{{ review.cached_product.slug }}/{% elif review.product_type == 'boat' %}/boats/product/{{ review.cached_product.slug }}/{% else %}#{% endif %}"
                                               class="btn btn-outline-primary btn-sm">
                                                <i class="fas fa-eye me-1"></i>
                                                –°–º–æ—Ç—Ä–µ—Ç—å —Ç–æ–≤–∞—Ä
                                            </a>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è —Å–Ω–∏–∑—É -->
                {% if page_obj.has_other_pages %}
                <nav aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –æ—Ç–∑—ã–≤–∞–º">
                    <ul class="pagination justify-content-center mt-4">
                        {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}">–ù–∞–∑–∞–¥</a>
                        </li>
                        {% endif %}

                        <li class="page-item active">
                            <span class="page-link">{{ page_obj.number }} –∏–∑ {{ page_obj.paginator.num_pages }}</span>
                        </li>

                        {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}">–í–ø–µ—Ä–µ–¥</a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
            {% else %}
            <!-- üì≠ –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
            <div class="text-center py-5">
                <i class="fas fa-star-half-alt fa-4x text-muted mb-4"></i>
                <h3 class="text-muted mb-3">–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤</h3>
                <p class="text-muted mb-4">
                    –°—Ç–∞–Ω—å—Ç–µ –ø–µ—Ä–≤—ã–º, –∫—Ç–æ –ø–æ–¥–µ–ª–∏—Ç—Å—è —Å–≤–æ–∏–º –º–Ω–µ–Ω–∏–µ–º –æ –Ω–∞—à–∏—Ö —Ç–æ–≤–∞—Ä–∞—Ö!<br>
                    –í–∞—à –æ—Ç–∑—ã–≤ –ø–æ–º–æ–∂–µ—Ç –¥—Ä—É–≥–∏–º –ø–æ–∫—É–ø–∞—Ç–µ–ª—è–º —Å–¥–µ–ª–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤—ã–±–æ—Ä.
                </p>
                <a href="{% url 'products_catalog' %}" class="btn btn-primary btn-lg">
                    <i class="fas fa-shopping-bag me-2"></i>
                    –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–æ–≤–∞—Ä—ã
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- üé® –ü—Ä–æ—Å—Ç—ã–µ —Å—Ç–∏–ª–∏ -->
<style>
.review-card {
    border: 1px solid #dee2e6;
    border-radius: 8px;
}

.product-image {
    max-height: 100px;
    width: 100%;
    object-fit: cover;
    border: 1px solid #e9ecef;
}

.no-image-placeholder {
    height: 100px;
    background-color: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 6px;
}

.like-btn, .dislike-btn {
    border-radius: 6px;
}

.btn {
    border-radius: 6px;
}

@media (max-width: 768px) {
    .product-image {
        max-height: 80px;
    }

    .no-image-placeholder {
        height: 80px;
    }
}
</style>

<!-- üì± JavaScript –¥–ª—è –ª–∞–π–∫–æ–≤ -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // üëçüëé –û–±—Ä–∞–±–æ—Ç–∫–∞ –ª–∞–π–∫–æ–≤/–¥–∏–∑–ª–∞–π–∫–æ–≤
    document.querySelectorAll('.like-btn, .dislike-btn').forEach(button => {
        button.addEventListener('click', function() {
            const reviewId = this.getAttribute('data-review-id');
            const action = this.getAttribute('data-action');

            // ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ URL –∏–∑ products/urls.py
            const url = action === 'like'
                ? `/products/toggle-like/${reviewId}/`
                : `/products/toggle-dislike/${reviewId}/`;

            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ - –∏—â–µ–º –≤ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
                    const buttonsContainer = this.closest('.d-flex');
                    const likeCount = buttonsContainer.querySelector('.like-btn .like-count');
                    const dislikeCount = buttonsContainer.querySelector('.dislike-btn .dislike-count');

                    if (likeCount) likeCount.textContent = data.likes;
                    if (dislikeCount) dislikeCount.textContent = data.dislikes;
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
            });
        });
    });
});
</script>
{% endblock %}