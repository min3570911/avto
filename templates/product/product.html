{% extends "base/base.html"%}
{% block title %}{{ product.product_name }}{% endblock %}
{% block start %} {% load crispy_forms_tags %}

<!-- ‚≠ê –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï CSS –ò JS –î–õ–Ø –ó–í–ï–ó–î–û–ß–ï–ö -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
/* üñºÔ∏è –°—Ç–∏–ª–∏ –¥–ª—è –∑—É–º–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π */
#mainImage {
    max-width: 100%;
    height: auto;
    object-fit: contain;
    transition: transform 0.25s ease;
    cursor: zoom-in;
}
.zoomed-in { transform: scale(2); cursor: zoom-out; }

/* üëç –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –ª–∞–π–∫–æ–≤/–¥–∏–∑–ª–∞–π–∫–æ–≤ */
.like-btn {
    background-color: #59ee8d; color: #fff; border: none; border-radius: 20px;
    padding: 0.4rem 1rem; transition: all 0.3s ease; font-weight: bold;
}
.like-btn:hover {
    background-color: #45c16b; transform: scale(1.1);
    box-shadow: 0 0 10px rgba(89, 238, 141, 0.5);
}
.dislike-btn {
    background-color: #ff7675; color: #fff; border: none; border-radius: 20px;
    padding: 0.4rem 1rem; transition: all 0.3s ease; font-weight: bold;
}
.dislike-btn:hover {
    background-color: #d65a5a; transform: scale(1.1);
    box-shadow: 0 0 10px rgba(255, 118, 117, 0.5);
}
@media (max-width: 768px) { .like-btn, .dislike-btn { padding: 0.3rem 0.8rem; font-size: 0.9rem; } }

/* üìè –£–º–µ–Ω—å—à–µ–Ω–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã –º–µ–∂–¥—É –±–ª–æ–∫–∞–º–∏ */
.content-body > div, .content-body > form { margin-bottom: 10px; }
.content-body label { margin-bottom: 5px; }
.kit-options { gap: 5px; margin-bottom: 10px; }
.kit-option-label { margin-bottom: 5px; padding: 5px 10px; }
.form-group { margin-bottom: 10px; }
hr { margin-top: 10px; margin-bottom: 10px; }

/* üé® –°—Ç–∏–ª–∏ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä–∞ –∫–æ–≤—Ä–∏–∫–æ–≤ */
.product-visualizer {
    position: relative; width: 100%; max-width: 380px; margin: 10px auto; min-height: 220px;
}
.product-visualizer img {
    position: absolute; top: 0; left: 0; width: 100%; height: auto; transition: all 0.3s ease;
}
.kit-base-image { z-index: 1; border: none !important; }
.matcolor { z-index: 2; }
.bordercolor { z-index: 3; }
.podpicon { z-index: 4; }

/* üîß –°—Ç–∏–ª–∏ –¥–ª—è –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏–π */
.kit-options-container { display: flex; }
.kit-options { flex: 1; display: flex; flex-direction: column; gap: 5px; margin-bottom: 10px; }
.kit-option-label {
    cursor: pointer; padding: 5px 10px; border: 1px solid #ccc; border-radius: 5px;
    transition: all 0.2s ease; flex: 1 0 100%; display: flex; align-items: center;
    margin-bottom: 5px; position: relative;
}
.kit-option-label:hover { border-color: #999; background-color: #f8f8f8; }
.kit-option-label.active { border-color: #007bff; background-color: #e6f2ff; }
.kit-option-label input { margin-right: 8px; }
.kit-option-label.active::after {
    content: "‚úì"; position: absolute; right: 10px; color: #007bff; font-weight: bold;
}

/* üé® –°—Ç–∏–ª–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ü–≤–µ—Ç–æ–≤ */
.color-wrapper { position: relative; margin-bottom: 8px; }
.color-picker { display: flex; flex-wrap: nowrap; margin-bottom: 5px; }
@media (min-width: 768px) { .color-picker { flex-wrap: wrap; } .scroll-indicator { display: none; } }
@media (max-width: 767px) {
  .color-wrapper { position: relative; overflow: hidden; }
  .color-picker {
      overflow-x: auto; -webkit-overflow-scrolling: touch; padding: 5px 3px;
      margin: -5px -3px 0; scrollbar-width: none;
  }
  .color-picker::-webkit-scrollbar { display: none; }
  .scroll-indicator {
      display: flex; align-items: center; justify-content: center; font-size: 12px; color: #666; margin-top: 3px;
  }
  .scroll-indicator i { margin: 0 3px; }
  .kit-option-label { padding: 6px; font-size: 1em; margin-bottom: 5px; }
}
.color-selection { flex: 0 0 auto; margin: 0 2px; text-align: center; }
@media (min-width: 768px) { .color-selection { margin: 0 6px 5px 0; } }
.color-item {
    display: inline-block; width: 28px; height: 28px; border-radius: 50%; cursor: pointer;
    border: 2px solid #ccc; transition: all 0.2s ease; margin: 0 auto;
}
.color-item:hover { transform: scale(1.1); border-color: #999; }
.color-item.active { border: 2px solid #FFEB3B; box-shadow: 0 0 5px rgba(0,0,0,0.5); }
.color-name { font-size: 10px; margin-top: 2px; text-align: center; min-width: 50px; }
@media (max-width: 767px) {
  .color-item { width: 32px; height: 32px; }
  .color-name { font-size: 11px; min-width: 50px; }
}

/* üñºÔ∏è –°—Ç–∏–ª–∏ –¥–ª—è –≥–∞–ª–µ—Ä–µ–∏ —Ç–æ–≤–∞—Ä–∞ */
.img-big-wrap { margin-bottom: 10px; text-align: center; }
.carousel-item { display: none; }
.carousel-item.active { display: block; }
.carousel-inner { position: relative; }
.thumbs-wrap { display: flex; flex-wrap: wrap; justify-content: center; margin-top: 8px; }
.item-thumb { margin: 0 3px; cursor: pointer; }
.item-thumb img {
    width: 50px; height: 50px; object-fit: cover; border: 1px solid #ddd; border-radius: 4px; transition: all 0.2s ease;
}
.item-thumb img:hover { border-color: #007bff; transform: scale(1.05); }
@media (max-width: 767px) { .gallery-wrap { display: none; } }

/* üìù –°—Ç–∏–ª–∏ –¥–ª—è –±–ª–æ–∫–∞ –æ–ø–∏—Å–∞–Ω–∏—è */
.product-description-block {
    background-color: #f9f9f9; border-radius: 8px; padding: 15px; margin: 15px 0;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}
.product-description-block h4 {
    color: #333; border-bottom: 2px solid #2a41e8; padding-bottom: 8px; margin-bottom: 15px; font-weight: 600;
}

/* üí∞ –°—Ç–∏–ª–∏ –¥–ª—è –±–ª–æ–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏ —Ü–µ–Ω—ã */
.quantity-price-block { border-top: 1px solid #eee; border-bottom: 1px solid #eee; padding: 8px 0; margin: 8px 0; background-color: #f8f8f8; border-radius: 5px; }
.kit-configuration-image { max-width: 300px; width: 100%; height: auto; margin: 5px auto; border: 1px solid #eee; border-radius: 5px; }

/* üî¢ –°—Ç–∏–ª–∏ –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏ —Ü–µ–Ω—ã */
.quantity-and-price { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; }
.quantity-selector { display: flex; align-items: center; }
.quantity-selector button { border: none; background-color: #f0f0f0; padding: 5px 10px; cursor: pointer; border-radius: 3px; }
.quantity-selector button:hover { background-color: #e0e0e0; }
.quantity-selector input { width: 50px; text-align: center; border: 1px solid #ccc; margin: 0 5px; padding: 5px; border-radius: 3px; }
.final-price { font-size: 1.2em; font-weight: bold; color: #2a41e8; }

/* üõ•Ô∏è –°—Ç–∏–ª–∏ –¥–ª—è —Ä–∞–∑–º–µ—Ä–æ–≤ –ª–æ–¥–æ–∫ */
.boat-dimensions {
    background: linear-gradient(135deg, #e3f2fd 0%, #f0f8ff 100%);
    border: 2px solid #2196f3; border-radius: 12px; padding: 20px; margin: 20px 0; text-align: center;
}
.boat-dimensions h6 { color: #1976d2; font-weight: 600; margin-bottom: 15px; font-size: 1.1rem; }
.boat-dimensions ul {
    list-style: none; padding: 0; margin: 0; display: flex; justify-content: center; gap: 30px; flex-wrap: wrap;
}
.boat-dimensions li {
    background: rgba(33, 150, 243, 0.1); padding: 10px 20px; border-radius: 25px; font-weight: 500; color: #1565c0;
    display: flex; align-items: center; gap: 8px;
}
.boat-dimensions li::before { content: "üìè"; font-size: 1.2rem; }
@media (max-width: 768px) { .boat-dimensions ul { flex-direction: column; gap: 15px; } .boat-dimensions li { justify-content: center; } }

/* ‚úÖ –°–¢–ò–õ–ò –î–õ–Ø WYSIWYG –ö–û–ù–¢–ï–ù–¢–ê */
.wysiwyg-content { line-height: 1.8; font-size: 1.05rem; color: #333; }
.wysiwyg-content h1, .wysiwyg-content h2, .wysiwyg-content h3, .wysiwyg-content h4, .wysiwyg-content h5, .wysiwyg-content h6 {
    margin-top: 1.5rem; margin-bottom: 1rem; color: #2c3e50; font-weight: 600;
}
.wysiwyg-content p { margin-bottom: 1rem; text-align: justify; }
.wysiwyg-content img { max-width: 100%; height: auto; margin: 1rem 0; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
.wysiwyg-content ul, .wysiwyg-content ol { margin: 1rem 0; padding-left: 2rem; }
.wysiwyg-content li { margin-bottom: 0.5rem; }
.wysiwyg-content blockquote {
    border-left: 4px solid #2a41e8; padding-left: 1rem; margin: 1rem 0; color: #666; font-style: italic;
    background-color: #f8f9fa; padding: 1rem; border-radius: 0 8px 8px 0;
}
.wysiwyg-content code { background-color: #f4f4f4; padding: 2px 6px; border-radius: 4px; font-family: 'Courier New', monospace; color: #e74c3c; }
.wysiwyg-content a { color: #2a41e8; text-decoration: none; border-bottom: 1px dotted #2a41e8; }
.wysiwyg-content a:hover { border-bottom-style: solid; }
.wysiwyg-content table { width: 100%; margin: 1rem 0; border-collapse: collapse; border: 1px solid #ddd; }
.wysiwyg-content table td, .wysiwyg-content table th { border: 1px solid #ddd; padding: 8px; text-align: left; }
.wysiwyg-content table th { background-color: #f5f5f5; font-weight: bold; }

/* ‚≠ê –°–¢–ò–õ–ò –î–õ–Ø –ò–ù–¢–ï–†–ê–ö–¢–ò–í–ù–´–• –ó–í–ï–ó–î–û–ß–ï–ö */
.star-rating-widget { display: flex; align-items: center; gap: 5px; margin: 10px 0; padding: 10px 0; }
.star-rating-widget .star { font-size: 1.8rem; color: #ddd; cursor: pointer; transition: all 0.2s ease; position: relative; display: inline-block; padding: 2px; }
.star-rating-widget .star:hover { transform: scale(1.1); color: #ffc107; }
.star-rating-widget .star.active { color: #ffc107; text-shadow: 0 0 5px rgba(255, 193, 7, 0.3); }
.star-rating-widget .star.hover { color: #ffc107; }

/* üé® –°—Ç–∏–ª–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–π—Ç–∏–Ω–≥–∞ –≤ –æ—Ç–∑—ã–≤–∞—Ö */
.review-stars { display: inline-flex; align-items: center; gap: 2px; margin-right: 10px; }
.review-stars .star { font-size: 1rem; color: #ffc107; }
.review-stars .star.empty { color: #ddd; }

/* üì± –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ */
@media (max-width: 768px) {
    .star-rating-widget .star { font-size: 1.6rem; gap: 3px; }
    .review-stars .star { font-size: 0.9rem; }
}

/* üéØ –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–æ—Ä–º—ã –æ—Ç–∑—ã–≤–∞ */
.review-form-container { background: #f8f9fa; border-radius: 12px; padding: 20px; margin: 20px 0; border: 1px solid #e9ecef; }
.review-form-container h5 { color: #495057; margin-bottom: 15px; font-weight: 600; }
.review-form-group { margin-bottom: 20px; }
.review-form-group label { font-weight: 600; color: #495057; margin-bottom: 8px; display: block; }
.review-content-textarea { border-radius: 8px; border: 1px solid #ced4da; padding: 12px; font-size: 1rem; resize: vertical; min-height: 100px; }
.review-content-textarea:focus { border-color: #007bff; box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25); outline: 0; }
.review-submit-btn {
    background: linear-gradient(45deg, #007bff, #0056b3); border: none; padding: 12px 30px; border-radius: 8px;
    color: white; font-weight: 600; cursor: pointer; transition: all 0.3s ease;
}
.review-submit-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3); }

/* ‚úÖ –°—Ç–∏–ª–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
.review-success-message { background: #d4edda; color: #155724; padding: 12px 16px; border-radius: 8px; border: 1px solid #c3e6cb; margin: 15px 0; }
.review-error-message { background: #f8d7da; color: #721c24; padding: 12px 16px; border-radius: 8px; border: 1px solid #f5c6cb; margin: 15px 0; }

/* üîí –°—Ç–∏–ª–∏ –¥–ª—è –æ–∂–∏–¥–∞–Ω–∏—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏ */
.pending-review {
    background: #fff3cd; color: #856404; padding: 12px 16px; border-radius: 8px; border: 1px solid #ffeaa7;
    margin: 15px 0; display: flex; align-items: center; gap: 10px;
}
.pending-review i { font-size: 1.2rem; color: #f39c12; }

/* üì± –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –æ—Ç–∑—ã–≤–æ–≤ */
.review-card { transition: all 0.3s ease; border-left: 4px solid #59ee8d; }
.review-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
.like-btn-static, .dislike-btn-static {
    background-color: #f8f9fa; color: #6c757d; border: none; border-radius: 20px;
    padding: 0.3rem 0.8rem; font-size: 0.9rem; cursor: not-allowed;
}
.moderation-status { border-top: 1px solid rgba(255, 193, 7, 0.3); padding-top: 8px; }
.auth-required-message {
    background: #f8f9fa; border-radius: 12px; padding: 30px; border: 2px dashed #dee2e6;
}
.no-reviews-message { background: #f8f9fa; border-radius: 12px; margin: 20px 0; }

@media (max-width: 768px) {
    .review-actions { flex-direction: column; align-items: stretch; gap: 8px; }
    .review-actions .btn { justify-content: center; width: 100%; }
}

/* üìä –°—á–µ—Ç—á–∏–∫ —Å–∏–º–≤–æ–ª–æ–≤ */
.character-counter { font-size: 0.85rem; color: #6c757d; text-align: right; margin-top: 5px; }
.character-counter.near-limit { color: #e74c3c; font-weight: 600; }

.add-to-cart-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.65rem;
    padding: 0.95rem 2.4rem;
    border-radius: 999px;
    font-size: 1.05rem;
    font-weight: 600;
    letter-spacing: 0.02em;
    background: linear-gradient(135deg, #2a41e8 0%, #6a11cb 100%);
    color: #fff;
    border: none;
    box-shadow: 0 12px 24px rgba(42, 65, 232, 0.28);
    text-decoration: none;
    transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
}

.add-to-cart-btn i {
    font-size: 1.2rem;
}

.add-to-cart-btn:hover,
.add-to-cart-btn:focus {
    transform: translateY(-2px) scale(1.02);
    box-shadow: 0 16px 30px rgba(42, 65, 232, 0.35);
    background: linear-gradient(135deg, #2338c4 0%, #5b0ec7 100%);
}

.add-to-cart-btn:active {
    transform: translateY(0);
    box-shadow: 0 8px 18px rgba(42, 65, 232, 0.25);
}

.add-to-cart-btn:focus-visible {
    outline: 3px solid rgba(255, 255, 255, 0.55);
    outline-offset: 3px;
}

@media (max-width: 576px) {
    .add-to-cart-btn {
        width: 100%;
        padding: 0.9rem 1.6rem;
        font-size: 1rem;
    }
}

</style>

<section class="section-content padding-y">
    <div class="container mt-3">
        {% include 'base/alert.html' %}
        <div class="card">
            <div class="row no-gutters">
                <aside class="col-md-4">
                    <div class="product-visualizer mx-auto mt-4 mb-4">
                        <img class="matcolor" src="/media/images/schema/sota1.png" alt="–ö–æ–≤—Ä–∏–∫">
                        <img class="bordercolor" src="/media/images/schema/border211.png" alt="–û–∫–∞–Ω—Ç–æ–≤–∫–∞">
                        <img class="podpicon" src="/media/images/schema/podp.png" alt="–ü–æ–¥–ø—è—Ç–Ω–∏–∫" style="display: none;">
                    </div>

                    <article class="gallery-wrap">
                        <div class="text-center mt-2 ml-3 mr-3 img-big-wrap">
                            <div class="carousel-inner">
                                {% for image in product.product_images.all %}
                                <div class="carousel-item {% if forloop.first %}active{% endif %}">
                                    <img id="mainImage" src="/media/{{ image.image }}" alt="{{ product.product_name }}" />
                                </div>
                                {% endfor %}
                            </div>

                            <div class="form-row thumbs-wrap mt-5 d-flex justify-content-center">
                                {% for image in product.product_images.all %}
                                <p class="item-thumb mx-2">
                                    <img src="/media/{{ image.image }}" class="img-thumbnail" onclick="updateMainImage(this.src)" />
                                </p>
                                {% endfor %}
                            </div>
                        </div>
                    </article>
                </aside>

                <main class="col-md-8 border-left">
                    <article class="content-body">
                        <!-- üõ•Ô∏è –£—Å–ª–æ–≤–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å —Ä–∞–∑–º–µ—Ä–∞–º–∏ –¥–ª—è –ª–æ–¥–æ–∫ -->
                        <h2 class="title">
                            {% if is_boat_product %}
                                {{ product.get_display_name_with_dimensions }}
                            {% else %}
                                {{ product.product_name }}
                            {% endif %}
                        </h2>
                        <h6 class="text-muted">{{ product.category }}</h6>

                        <!-- üõ•Ô∏è –ë–ª–æ–∫ —Ä–∞–∑–º–µ—Ä–æ–≤ –¢–û–õ–¨–ö–û –¥–ª—è –ª–æ–¥–æ–∫ -->
                        {% if is_boat_product and product.boat_mat_length and product.boat_mat_width %}
                        <div class="boat-dimensions">
                            <h6>üìè –†–∞–∑–º–µ—Ä—ã –∫–æ–≤—Ä–∏–∫–∞:</h6>
                            <ul>
                                <li>–î–ª–∏–Ω–∞: {{ product.boat_mat_length }} —Å–º</li>
                                <li>–®–∏—Ä–∏–Ω–∞: {{ product.boat_mat_width }} —Å–º</li>
                            </ul>
                        </div>
                        {% endif %}

                        <hr />
                        <label><strong>–°–û–ë–ï–†–ò –°–í–û–ô –ó–ê–ö–ê–ó:</strong></label>

                        <!-- –í—ã–±–æ—Ä —Ü–≤–µ—Ç–∞ –∫–æ–≤—Ä–∏–∫–∞ -->
                        <div class="form-group">
                            <label><strong>–¶–≤–µ—Ç –∫–æ–≤—Ä–∏–∫–∞</strong></label>
                            <div class="color-wrapper">
                                <div class="color-picker" data-color-type="carpet">
                                    {% for color in carpet_colors %}
                                    <div class="color-selection">
                                        <div class="color-item {% if color.uid == initial_carpet_color.uid %}active{% endif %}"
                                             data-color-uuid="{{ color.uid }}"
                                             data-image-url="{{ color.get_image_url }}"
                                             data-is-available="{{ color.is_available|yesno:'true,false' }}"
                                             title="{{ color.name }}{% if not color.is_available %} (–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏){% endif %}"
                                             style="background-color: {{ color.hex_code }};
                                                    {% if color.uid == initial_carpet_color.uid %}border: 2px solid #FFEB3B;{% endif %}
                                                    {% if not color.is_available %}opacity: 0.5; cursor: not-allowed;{% endif %}"
                                             {% if color.is_available %}onclick="activateColor(this, 'carpet');"{% endif %}>
                                            {% if not color.is_available %}
                                                <div class="unavailable-overlay">‚úï</div>
                                            {% endif %}
                                        </div>
                                        <div class="color-name {% if not color.is_available %}text-muted{% endif %}">{{ color.name }}</div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% if carpet_colors|length > 6 %}
                                <div class="scroll-indicator d-md-none">
                                    <i class="fas fa-chevron-left"></i>
                                    <span>–ü—Ä–æ–∫—Ä—É—Ç–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</span>
                                    <i class="fas fa-chevron-right"></i>
                                </div>
                                {% endif %}
                            </div>
                            <input type="hidden" name="carpet_color" id="carpet_color_input" value="{{ initial_carpet_color.uid }}">
                        </div>

                        <!-- –í—ã–±–æ—Ä —Ü–≤–µ—Ç–∞ –æ–∫–∞–Ω—Ç–æ–≤–∫–∏ -->
                        <div class="form-group">
                            <label><strong>–¶–≤–µ—Ç –æ–∫–∞–Ω—Ç–æ–≤–∫–∏</strong></label>
                            <div class="color-wrapper">
                                <div class="color-picker" data-color-type="border">
                                    {% for color in border_colors %}
                                    <div class="color-selection">
                                        <div class="color-item {% if color.uid == initial_border_color.uid %}active{% endif %}"
                                             data-color-uuid="{{ color.uid }}"
                                             data-image-url="{{ color.get_image_url }}"
                                             data-is-available="{{ color.is_available|yesno:'true,false' }}"
                                             title="{{ color.name }}{% if not color.is_available %} (–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏){% endif %}"
                                             style="background-color: {{ color.hex_code }};
                                                    {% if color.uid == initial_border_color.uid %}border: 2px solid #FFEB3B;{% endif %}
                                                    {% if not color.is_available %}opacity: 0.5; cursor: not-allowed;{% endif %}"
                                             {% if color.is_available %}onclick="activateColor(this, 'border');"{% endif %}>
                                            {% if not color.is_available %}
                                                <div class="unavailable-overlay">‚úï</div>
                                            {% endif %}
                                        </div>
                                        <div class="color-name {% if not color.is_available %}text-muted{% endif %}">{{ color.name }}</div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% if border_colors|length > 6 %}
                                <div class="scroll-indicator d-md-none">
                                    <i class="fas fa-chevron-left"></i>
                                    <span>–ü—Ä–æ–∫—Ä—É—Ç–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</span>
                                    <i class="fas fa-chevron-right"></i>
                                </div>
                                {% endif %}
                            </div>
                            <input type="hidden" name="border_color" id="border_color_input" value="{{ initial_border_color.uid }}">
                        </div>

                        <!-- üöó –ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è –¢–û–õ–¨–ö–û –¥–ª—è –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π -->
                        {% if not is_boat_product %}
                        <div>
                            <h6 class="font-weight-bold text-uppercase mb-2">–ö–û–ú–ü–õ–ï–ö–¢–ê–¶–ò–Ø</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="kit-options">
                                        {% for kit in sorted_kit_variants %}
                                        <label class="kit-option-label {% if forloop.first %}active{% endif %}" for="kit-{{ kit.code }}">
                                            <input type="radio" name="selected_kit" value="{{ kit.code }}" id="kit-{{ kit.code }}"
                                                   {% if forloop.first %}checked{% endif %} class="custom-control-input" />
                                            {{ kit.name }} ({{ kit.price_modifier }} —Ä—É–±.)
                                        </label>
                                        {% endfor %}

                                        <div class="form-check mt-3">
                                            <input class="form-check-input" type="checkbox" id="podp_check" data-attr-id="7" data-attr-value="1">
                                            <label class="form-check-label" for="podp_check">
                                                –ü–æ–¥–ø—è—Ç–Ω–∏–∫ ({{ podpyatnik_option.price_modifier }} —Ä—É–±.)
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <img id="kit-image" src="/media/images/schema/salon.png" alt="–ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è" class="kit-configuration-image mb-2">
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <div class="quantity-and-price">
                            <div class="quantity-selector">
                                <button type="button" id="button-minus">-</button>
                                <input type="text" value="1" id="quantity" />
                                <button type="button" id="button-plus">+</button>
                            </div>

                            <div class="final-price">
                                –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: <span class="font-weight-bold" id="finalPrice">{{ updated_price|stringformat:".2f" }}</span> —Ä—É–±.
                            </div>
                        </div>

                        <div class="form-group d-flex justify-content-start mt-3">
                            <div class="d-sm-flex">

                                <form method="POST" action="{% url 'add_to_cart' product.uid %}" id="cart-form">
                                    {% csrf_token %}
                                    <input type="hidden" name="kit" id="cart-kit" value="">
                                    <input type="hidden" name="carpet_color" id="cart-carpet-color" value="">
                                    <input type="hidden" name="border_color" id="cart-border-color" value="">
                                    <input type="hidden" name="podp" id="cart-podp" value="0">
                                    <input type="hidden" name="quantity" id="cart-quantity" value="1">
                                    <button type="submit" class="btn btn-primary add-to-cart-btn">
                                        <i class="fas fa-shopping-bag"></i>
                                        <span>–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É</span>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </article>
                </main>
            </div>
        </div>

        <!-- üìù –ë–õ–û–ö –û–ü–ò–°–ê–ù–ò–Ø –¢–û–í–ê–†–ê -->
        <div class="product-description-block mt-4 mb-4">
            <h4>–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</h4>
            <div class="wysiwyg-content">
                {% if product.product_desription.html %}
                    {{ product.product_desription.html|safe }}
                {% else %}
                    {{ product.product_desription|safe }}
                {% endif %}
            </div>
        </div>

        <!-- ‚≠ê –ù–û–í–´–ô –ë–õ–û–ö –û–¢–ó–´–í–û–í –° –ó–í–ï–ó–î–û–ß–ö–ê–ú–ò –ò –ú–û–î–ï–†–ê–¶–ò–ï–ô (–î–õ–Ø –í–°–ï–• –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô) -->
        <div class="reviews-section mt-4">
            <h3 class="title padding-bottom-sm d-flex align-items-center">
                <i class="fas fa-comments me-2"></i>
                –û—Ç–∑—ã–≤—ã
                {% if reviews %}
                <span class="badge bg-primary ms-2">{{ reviews.count }}</span>
                {% endif %}
            </h3>

            <!-- ‚ö†Ô∏è –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø –û –ú–û–î–ï–†–ê–¶–ò–ò -->
            {% if messages %}
                {% for message in messages %}
                    {% if '–º–æ–¥–µ—Ä–∞—Ü–∏—é' in message.message or '–æ–∂–∏–¥–∞–µ—Ç' in message.message %}
                    <div class="pending-review">
                        <i class="fas fa-clock"></i>
                        <span>{{ message.message }}</span>
                    </div>
                    {% elif message.tags == 'success' %}
                    <div class="review-success-message">
                        <i class="fas fa-check-circle me-2"></i>{{ message.message }}
                    </div>
                    {% elif message.tags == 'error' %}
                    <div class="review-error-message">
                        <i class="fas fa-exclamation-triangle me-2"></i>{{ message.message }}
                    </div>
                    {% endif %}
                {% endfor %}
            {% endif %}

            <!-- ‚úÖ –û–¢–ó–´–í–´ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–π qs) -->
            {% for review in reviews %}
            <div class="card mb-3 review-card">
                <div class="card-body" style="background-color: #59ee8d91">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="review-content flex-grow-1">
                            <div class="review-header mb-2">
                                <div class="d-flex align-items-center mb-2">
                                    <!-- üë§ –ê–≤—Ç–æ—Ä: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–ª–∏ –≥–æ—Å—Ç—å -->
                                    <strong class="me-3">
                                        {% if review.user %}
                                            {{ review.user.get_full_name|default:review.user.username }}
                                        {% else %}
                                            {{ review.reviewer_name|default:"–ê–Ω–æ–Ω–∏–º–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å" }}
                                        {% endif %}
                                    </strong>

                                    <div class="review-stars me-2">
                                        {% for star in "12345" %}
                                            {% if forloop.counter <= review.stars %}
                                                <i class="fas fa-star"></i>
                                            {% else %}
                                                <i class="fas fa-star empty"></i>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                    <small class="text-muted">{{ review.date_added|date:"d.m.Y –≤ H:i" }}</small>
                                </div>
                            </div>

                            <div class="review-text">
                                <p class="mb-2">{{ review.content }}</p>
                            </div>
                        </div>

                        <!-- üí¨ –û—Ç–≤–µ—Ç—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ -->
                        {% if review.admin_replies.exists %}
                        <div class="admin-replies mt-3">
                            {% for reply in review.admin_replies.all %}
                            {% if reply.is_published %}
                            <div class="admin-reply p-3 bg-light rounded mb-2">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-user-shield text-primary me-2"></i>
                                    <strong class="text-primary">{{ reply.get_admin_name }}</strong>
                                    <small class="text-muted ms-auto">{{ reply.reply_date|date:"d.m.Y –≤ H:i" }}</small>
                                </div>
                                <p class="mb-0">{{ reply.reply_text }}</p>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                        {% endif %}

                        <!-- üóëÔ∏è –î–ï–ô–°–¢–í–ò–Ø -->
                        <div class="review-actions d-flex flex-wrap align-items-center gap-2 mt-3">

                            <!-- üóëÔ∏è –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∞ -->
                            {% if review.user == request.user %}
                            <button class="btn btn-outline-danger btn-sm"
                                    title="–£–¥–∞–ª–∏—Ç—å –æ—Ç–∑—ã–≤"
                                    data-bs-toggle="modal"
                                    data-bs-target="#deleteReviewModal"
                                    onclick="setDeleteAction('{% url 'delete_review' product.slug review.uid %}')">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                            {% endif %}

                            <!-- üë®‚Äçüíº –ö–Ω–æ–ø–∫–∏ –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ -->
                            {% if request.user.is_staff %}
                                {% if not review.is_approved %}
                                <button class="btn btn-success btn-sm" onclick="moderateReview('{{ review.uid }}', 'approve')" title="–û–¥–æ–±—Ä–∏—Ç—å –æ—Ç–∑—ã–≤">
                                    <i class="fas fa-check"></i> –û–¥–æ–±—Ä–∏—Ç—å
                                </button>
                                {% endif %}
                                <button class="btn btn-warning btn-sm" onclick="moderateReview('{{ review.uid }}', 'reject')" title="–û—Ç–∫–ª–æ–Ω–∏—Ç—å –æ—Ç–∑—ã–≤">
                                    <i class="fas fa-times"></i> –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="no-reviews-message text-center py-4">
                <i class="fas fa-comment-slash fa-3x text-muted mb-3"></i>
                <p class="text-muted">–û—Ç–∑—ã–≤–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</p>
            </div>
            {% endfor %}

            <!-- ‚úçÔ∏è –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–ê–Ø –§–û–†–ú–ê –î–û–ë–ê–í–õ–ï–ù–ò–Ø –û–¢–ó–´–í–ê (–î–õ–Ø –í–°–ï–• –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô) -->
            <div class="review-form-container">
                <h5>
                    <i class="fas fa-edit me-2"></i>
                    {% if user_existing_review %}
                        –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–∞—à –æ—Ç–∑—ã–≤
                    {% else %}
                        –û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤
                    {% endif %}
                </h5>

                <form method="POST" action="{% url 'get_product' product.slug %}" class="review-form" id="reviewForm">
                    {% csrf_token %}

                    {% if not request.user.is_authenticated %}
                    <!-- üçØ Honeypot -->
                    <input type="text" name="website" style="display:none;" tabindex="-1" autocomplete="off">
                    <!-- ‚è±Ô∏è –í—Ä–µ–º–µ–Ω–Ω–∞—è –º–µ—Ç–∫–∞ -->
                    <input type="hidden" name="form_timestamp" value="{{ form_timestamp }}">
                    {% endif %}

                    {% if not request.user.is_authenticated %}
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="review-form-group">
                                <label for="id_reviewer_name">–í–∞—à–µ –∏–º—è <span class="text-danger">*</span></label>
                                <input type="text" name="reviewer_name" id="id_reviewer_name" class="form-control"
                                       placeholder="–ö–∞–∫ –∫ –≤–∞–º –æ–±—Ä–∞—â–∞—Ç—å—Å—è?" required maxlength="100"
                                       value="{% if review_form.reviewer_name.value %}{{ review_form.reviewer_name.value }}{% endif %}">
                                {% if review_form.reviewer_name.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in review_form.reviewer_name.errors %}
                                        <i class="fas fa-exclamation-triangle me-1"></i>{{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="review-form-group">
                                <label for="id_reviewer_email">Email <span class="text-muted">(–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –Ω–µ –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è)</span></label>
                                <input type="email" name="reviewer_email" id="id_reviewer_email" class="form-control"
                                       placeholder="–¥–ª—è —Å–≤—è–∑–∏ (–Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è)" maxlength="254"
                                       value="{% if review_form.reviewer_email.value %}{{ review_form.reviewer_email.value }}{% endif %}">
                                <small class="form-text text-muted"><i class="fas fa-lock me-1"></i>Email –Ω–µ –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–≤—è–∑–∏</small>
                                {% if review_form.reviewer_email.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in review_form.reviewer_email.errors %}
                                        <i class="fas fa-exclamation-triangle me-1"></i>{{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- ‚≠ê –û—Ü–µ–Ω–∫–∞ -->
                    <div class="review-form-group">
                        <label>–í–∞—à–∞ –æ—Ü–µ–Ω–∫–∞ <span class="text-danger">*</span></label>
                        <div class="star-rating-widget" data-field-name="stars">
                            <input type="hidden" name="stars"
                                   value="{% if user_existing_review %}{{ user_existing_review.stars }}{% elif review_form.stars.value %}{{ review_form.stars.value }}{% else %}0{% endif %}"
                                   id="id_stars">
                            {% for i in "12345" %}
                            <span class="star
                                {% if user_existing_review and forloop.counter <= user_existing_review.stars %}active{% elif review_form.stars.value and forloop.counter <= review_form.stars.value %}active{% endif %}"
                                  data-value="{{ forloop.counter }}"
                                  title="{{ forloop.counter }} –∑–≤–µ–∑–¥{% if forloop.counter == 1 %}–∞{% elif forloop.counter <= 4 %}—ã{% endif %}">
                                <i class="fas fa-star"></i>
                            </span>
                            {% endfor %}
                        </div>
                        <small class="form-text text-muted">–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∑–≤–µ–∑–¥–æ—á–∫–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ –æ—Ü–µ–Ω–∫–∏</small>

                        {% if review_form.stars.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in review_form.stars.errors %}<i class="fas fa-exclamation-triangle me-1"></i>{{ error }}{% endfor %}
                        </div>
                        {% endif %}
                    </div>

                    <!-- üìù –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π -->
                    <div class="review-form-group">
                        <label for="id_content">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π <span class="text-danger">*</span></label>
                        <textarea name="content" id="id_content" class="form-control review-content-textarea" rows="4"
                                  placeholder="–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –≤–∞—à–∏–º –º–Ω–µ–Ω–∏–µ–º –æ —Ç–æ–≤–∞—Ä–µ..." maxlength="1000" required>{% if user_existing_review %}{{ user_existing_review.content }}{% elif review_form.content.value %}{{ review_form.content.value }}{% endif %}</textarea>
                        <small class="form-text text-muted">–ú–∏–Ω–∏–º—É–º 10 —Å–∏–º–≤–æ–ª–æ–≤, –º–∞–∫—Å–∏–º—É–º 1000</small>

                        {% if review_form.content.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in review_form.content.errors %}<i class="fas fa-exclamation-triangle me-1"></i>{{ error }}{% endfor %}
                        </div>
                        {% endif %}
                    </div>

                    <!-- üöÄ –û—Ç–ø—Ä–∞–≤–∫–∞ -->
                    <div class="text-end">
                        <button type="submit" name="review_submit" class="review-submit-btn">
                            <i class="fas fa-paper-plane me-2"></i>
                            {% if user_existing_review %}–û–±–Ω–æ–≤–∏—Ç—å –æ—Ç–∑—ã–≤{% else %}–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤{% endif %}
                        </button>
                    </div>

                    <!-- üí° –ò–Ω—Ñ–æ –æ –º–æ–¥–µ—Ä–∞—Ü–∏–∏ -->
                    <div class="moderation-info mt-3">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            –í—Å–µ –æ—Ç–∑—ã–≤—ã –ø—Ä–æ—Ö–æ–¥—è—Ç –º–æ–¥–µ—Ä–∞—Ü–∏—é –ø–µ—Ä–µ–¥ –ø—É–±–ª–∏–∫–∞—Ü–∏–µ–π.
                            {% if user_existing_review and not user_existing_review.is_approved %}
                                –í–∞—à —Ç–µ–∫—É—â–∏–π –æ—Ç–∑—ã–≤ –æ–∂–∏–¥–∞–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏.
                            {% endif %}
                            {% if not request.user.is_authenticated %}
                                –î–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —É–¥–∞–ª–µ–Ω–∏—è –æ—Ç–∑—ã–≤–∞ –≤ –±—É–¥—É—â–µ–º —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É.
                            {% endif %}
                        </small>
                    </div>
                </form>
            </div>

        </div>

        <!-- üóëÔ∏è –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –£–î–ê–õ–ï–ù–ò–Ø –û–¢–ó–´–í–ê (–¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö) -->
        <div class="modal fade" id="deleteReviewModal" tabindex="-1" aria-labelledby="deleteReviewModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="deleteReviewModalLabel">
                            <i class="fas fa-trash me-2"></i>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="text-center">
                            <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                            <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –æ—Ç–∑—ã–≤?</p>
                            <p class="text-muted small">–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>–û—Ç–º–µ–Ω–∞
                        </button>
                        <form id="deleteReviewForm" method="POST" style="display: inline">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger">
                                <i class="fas fa-trash me-1"></i>–£–¥–∞–ª–∏—Ç—å –æ—Ç–∑—ã–≤
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- üîß –°–ö–†–´–¢–´–ï –î–ê–ù–ù–´–ï –î–õ–Ø JavaScript -->
<meta name="product-price" content="{{ updated_price }}">
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
<div id="kit-variant-data" style="display: none;">
    {% for kit in sorted_kit_variants %}
    <div
        data-kit-code="{{ kit.code }}"
        data-kit-image="{% if kit.image %}{{ kit.image.url }}{% else %}/media/images/schema/salon.png{% endif %}"
        data-kit-price="{{ kit.price_modifier }}"
    ></div>
    {% endfor %}
    <div data-option-code="podpyatnik" data-option-price="{{ podpyatnik_option.price_modifier }}"></div>
</div>

<!-- üõ•Ô∏è –ü–µ—Ä–µ–¥–∞—á–∞ —Ç–∏–ø–∞ —Ç–æ–≤–∞—Ä–∞ –≤ JavaScript -->
<script>window.isBoatProduct = {{ is_boat_product|yesno:"true,false" }};</script>

<!-- ‚≠ê JAVASCRIPT –î–õ–Ø –ò–ù–¢–ï–†–ê–ö–¢–ò–í–ù–´–• –ó–í–ï–ó–î–û–ß–ï–ö -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    initializeStarRatingWidgets();
    initializeCharacterCounter();
});

function initializeStarRatingWidgets() {
    const widgets = document.querySelectorAll('.star-rating-widget');
    widgets.forEach(widget => {
        const stars = widget.querySelectorAll('.star');
        const hiddenInput = widget.querySelector('input[type="hidden"]');
        if (!hiddenInput) return;

        stars.forEach(star => {
            const starValue = parseInt(star.getAttribute('data-value'));
            star.addEventListener('click', function() {
                setRating(widget, starValue, hiddenInput);
                clearHoverEffect(stars);
            });
            star.addEventListener('mouseenter', function() { showHoverEffect(stars, starValue); });
            star.addEventListener('mouseleave', function() {
                clearHoverEffect(stars);
                restoreCurrentRating(widget, hiddenInput);
            });
        });

        restoreCurrentRating(widget, hiddenInput);
    });
}

function setRating(widget, rating, hiddenInput) {
    hiddenInput.value = rating;
    const stars = widget.querySelectorAll('.star');
    stars.forEach(star => {
        const starValue = parseInt(star.getAttribute('data-value'));
        if (starValue <= rating) { star.classList.add('active'); star.classList.remove('hover'); }
        else { star.classList.remove('active', 'hover'); }
    });
    showRatingConfirmation(widget, rating);
    clearValidationErrors(widget);
}

function showHoverEffect(stars, hoverRating) {
    stars.forEach(star => {
        const starValue = parseInt(star.getAttribute('data-value'));
        if (starValue <= hoverRating) star.classList.add('hover');
        else star.classList.remove('hover');
    });
}
function clearHoverEffect(stars) { stars.forEach(star => star.classList.remove('hover')); }

function restoreCurrentRating(widget, hiddenInput) {
    const currentRating = parseInt(hiddenInput.value) || 0;
    const stars = widget.querySelectorAll('.star');
    stars.forEach(star => {
        const starValue = parseInt(star.getAttribute('data-value'));
        if (starValue <= currentRating) star.classList.add('active'); else star.classList.remove('active');
        star.classList.remove('hover');
    });
}

function showRatingConfirmation(widget, rating) {
    const existing = widget.querySelector('.rating-confirmation'); if (existing) existing.remove();
    const el = document.createElement('div');
    el.className = 'rating-confirmation';
    el.style.cssText = 'color:#28a745;font-size:.9rem;font-weight:600;margin-left:15px;opacity:0;transition:opacity .3s ease;';
    el.innerHTML = '<i class="fas fa-check-circle"></i> ' + getRatingText(rating);
    widget.appendChild(el);
    setTimeout(()=>{ el.style.opacity='1'; },100);
    setTimeout(()=>{ if(el.parentNode){ el.style.opacity='0'; setTimeout(()=>{ if(el.parentNode){ el.remove(); } },300); } },3000);
}
function getRatingText(rating){
    const t={1:'–û—á–µ–Ω—å –ø–ª–æ—Ö–æ',2:'–ü–ª–æ—Ö–æ',3:'–ù–æ—Ä–º–∞–ª—å–Ω–æ',4:'–•–æ—Ä–æ—à–æ',5:'–û—Ç–ª–∏—á–Ω–æ'}; return t[rating] || '–û—Ü–µ–Ω–∫–∞ –≤—ã–±—Ä–∞–Ω–∞';
}
function clearValidationErrors(widget){
    const errs = widget.parentNode.querySelectorAll('.invalid-feedback, .error-message');
    errs.forEach(e=>e.style.display='none');
    const group = widget.closest('.form-group, .review-form-group');
    if (group) group.classList.remove('has-error','is-invalid');
}

function initializeCharacterCounter(){
    const textareas=document.querySelectorAll('.review-content-textarea');
    textareas.forEach(textarea=>{
        const maxLength=parseInt(textarea.getAttribute('maxlength'))||1000;
        const counter=document.createElement('div');
        counter.className='character-counter';
        counter.textContent=`0 / ${maxLength}`;
        textarea.parentNode.insertBefore(counter, textarea.nextSibling);
        textarea.addEventListener('input', function(){
            const n=this.value.length;
            counter.textContent=`${n} / ${maxLength}`;
            if(n>maxLength*0.9){counter.classList.add('near-limit');}else{counter.classList.remove('near-limit');}
        });
        textarea.dispatchEvent(new Event('input'));
    });
}

// üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ
function setDeleteAction(url) { document.getElementById('deleteReviewForm').action = url; }

// üë®‚Äçüíº –ú–æ–¥–µ—Ä–∞—Ü–∏—è
function moderateReview(reviewUid, action) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    fetch(`/products/moderate-review/${reviewUid}/${action}/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrfToken, 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: action, review_uid: reviewUid })
    })
    .then(r=>r.json())
    .then(data=>{
        if(data.success){ location.reload(); }
        else{ alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞')); }
    })
    .catch(err=>{ console.error('–û—à–∏–±–∫–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏:', err); alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –æ—Ç–∑—ã–≤–∞'); });
}

// üëçüëé –õ–∞–π–∫/–¥–∏–∑–ª–∞–π–∫
function toggleLike(reviewUid){
    const csrfToken=document.querySelector('[name=csrfmiddlewaretoken]').value;
    fetch(`/products/toggle-like/${reviewUid}/`, { method:'POST', headers:{'X-CSRFToken':csrfToken,'Content-Type':'application/json'} })
    .then(r=>r.json())
    .then(d=>{ if(d.success){ document.getElementById(`like-count-${reviewUid}`).textContent=d.likes; document.getElementById(`dislike-count-${reviewUid}`).textContent=d.dislikes; } })
    .catch(e=>console.error('–û—à–∏–±–∫–∞ –ª–∞–π–∫–∞:', e));
}
function toggleDislike(reviewUid){
    const csrfToken=document.querySelector('[name=csrfmiddlewaretoken]').value;
    fetch(`/products/toggle-dislike/${reviewUid}/`, { method:'POST', headers:{'X-CSRFToken':csrfToken,'Content-Type':'application/json'} })
    .then(r=>r.json())
    .then(d=>{ if(d.success){ document.getElementById(`like-count-${reviewUid}`).textContent=d.likes; document.getElementById(`dislike-count-${reviewUid}`).textContent=d.dislikes; } })
    .catch(e=>console.error('–û—à–∏–±–∫–∞ –¥–∏–∑–ª–∞–π–∫–∞:', e));
}

// üìù –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ —Ñ–æ—Ä–º—É –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
document.addEventListener('DOMContentLoaded', function(){
    const hasFormErrors = document.querySelector('.invalid-feedback');
    if (hasFormErrors) {
        const reviewForm = document.getElementById('reviewForm');
        if (reviewForm) reviewForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
});
</script>

<!-- üîß –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –û–°–ù–û–í–ù–û–ì–û JS –§–ê–ô–õ–ê -->
<script src="/media/js/product.js" type="text/javascript"></script>

{% endblock %}

